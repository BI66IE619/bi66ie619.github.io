<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realm Forge - Multiplayer RPG</title>
    <style>
        /* Gaming Theme Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, hsl(220, 13%, 8%), hsl(220, 13%, 12%));
            color: hsl(120, 100%, 85%);
            overflow: hidden;
            height: 100vh;
        }

        .game-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: relative;
        }

        .game-canvas {
            border: 2px solid hsl(120, 100%, 30%);
            border-radius: 8px;
            box-shadow: 0 0 20px hsl(120, 100%, 50%, 0.5);
            cursor: crosshair;
        }

        .game-ui {
            position: fixed;
            background: hsl(220, 13%, 10%);
            border: 1px solid hsl(120, 100%, 30%);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 0 20px hsl(120, 100%, 50%, 0.5);
        }

        .player-stats {
            top: 16px;
            left: 16px;
            min-width: 280px;
        }

        .minimap-panel {
            top: 16px;
            right: 16px;
            width: 200px;
            height: 140px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .minimap-panel.expanded {
            width: 400px;
            height: 300px;
            z-index: 1000;
        }

        .minimap-canvas {
            width: 100%;
            height: 120px;
            border: 1px solid hsl(120, 100%, 30%);
            border-radius: 4px;
            background: hsl(220, 13%, 8%);
        }

        .player-count-box {
            margin-top: 8px;
            padding: 6px;
            background: hsl(220, 13%, 8%);
            border: 1px solid hsl(120, 100%, 30%);
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }

        .chat-panel {
            bottom: 16px;
            left: 16px;
            width: 280px;
            height: 40px;
            display: flex;
            flex-direction: column;
            transition: height 0.3s ease;
        }

        .chat-panel.expanded {
            height: 280px;
        }

        .controls-panel {
            bottom: 16px;
            right: 16px;
            max-width: 300px;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: hsl(0, 100%, 60%);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            transition: background 0.3s ease;
        }

        .close-button:hover {
            background: hsl(0, 100%, 70%);
        }

        .neon-text {
            color: hsl(120, 100%, 50%);
            text-shadow: 0 0 10px hsl(120, 100%, 50%, 0.8);
        }

        .health-bar, .mana-bar {
            height: 12px;
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .health-bar {
            background: hsl(0, 100%, 60%);
            box-shadow: 0 0 10px hsl(0, 100%, 60%, 0.7);
        }

        .mana-bar {
            background: hsl(240, 100%, 60%);
            box-shadow: 0 0 10px hsl(240, 100%, 60%, 0.7);
        }

        .bar-background {
            background: hsl(220, 13%, 15%);
            border-radius: 6px;
            overflow: hidden;
        }

        input, button {
            background: hsl(220, 13%, 15%);
            border: 1px solid hsl(120, 100%, 30%);
            color: hsl(120, 100%, 85%);
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        button {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: hsl(120, 100%, 20%);
            box-shadow: 0 0 10px hsl(120, 100%, 50%, 0.3);
        }

        .character-select {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: hsl(220, 13%, 10%);
            border: 2px solid hsl(120, 100%, 30%);
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 0 30px hsl(120, 100%, 50%, 0.5);
            text-align: center;
            min-width: 400px;
        }

        .class-selection {
            display: flex;
            gap: 16px;
            margin: 20px 0;
            justify-content: center;
        }

        .class-button {
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .class-button:hover, .class-button.selected {
            background: hsl(120, 100%, 20%);
            box-shadow: 0 0 15px hsl(120, 100%, 50%, 0.5);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: hsl(220, 13%, 8%);
            border-radius: 4px;
            margin-bottom: 12px;
            max-height: 200px;
            display: none;
        }

        .chat-panel.expanded .chat-messages {
            display: block;
        }

        .message {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .message .username {
            color: hsl(120, 100%, 50%);
            font-weight: bold;
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
        }

        .chat-panel:not(.expanded) .chat-input-container {
            display: none;
        }

        .chat-toggle {
            cursor: pointer;
            user-select: none;
            transition: color 0.3s ease;
        }

        .chat-toggle:hover {
            color: hsl(120, 100%, 70%);
        }

        .chat-input {
            flex: 1;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
        }

        .current-player {
            background: hsl(120, 100%, 20%, 0.3);
            border: 1px solid hsl(120, 100%, 30%);
        }

        .other-player {
            background: hsl(220, 13%, 8%, 0.5);
        }

        .player-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .current-player .player-dot {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hidden {
            display: none;
        }

        .interaction-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: hsl(220, 13%, 10%);
            border: 2px solid hsl(120, 100%, 30%);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 0 30px hsl(120, 100%, 50%, 0.5);
            min-width: 400px;
            max-width: 500px;
            z-index: 1000;
        }

        .shop-items {
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: hsl(220, 13%, 8%);
            border-radius: 4px;
            border: 1px solid hsl(120, 100%, 20%);
        }

        .shop-item:hover {
            background: hsl(120, 100%, 15%);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .controls-text {
            font-size: 12px;
            color: hsl(120, 20%, 65%);
            line-height: 1.4;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .gold-amount {
            color: hsl(60, 100%, 50%);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" class="game-canvas" width="1200" height="800"></canvas>
    </div>

    <!-- Character Selection -->
    <div id="characterSelect" class="character-select">
        <h1 class="neon-text" style="margin-bottom: 24px;">Welcome to Realm Forge</h1>
        <p style="margin-bottom: 20px;">Enter your name and choose your class:</p>
        
        <input type="text" id="playerName" placeholder="Enter your name..." style="width: 100%; margin-bottom: 20px;">
        
        <div class="class-selection">
            <div class="class-button" data-class="warrior">
                <div style="font-size: 24px;">⚔</div>
                <div>Warrior</div>
                <div style="font-size: 10px;">High HP, Low MP</div>
            </div>
            <div class="class-button" data-class="mage">
                <div style="font-size: 24px;">✦</div>
                <div>Mage</div>
                <div style="font-size: 10px;">Low HP, High MP</div>
            </div>
            <div class="class-button" data-class="archer">
                <div style="font-size: 24px;">➵</div>
                <div>Archer</div>
                <div style="font-size: 10px;">Balanced Stats</div>
            </div>
        </div>
        
        <button id="startGame" style="width: 100%; margin-top: 20px;">Start Adventure</button>
    </div>

    <!-- Player Stats Panel -->
    <div id="playerStats" class="game-ui player-stats hidden">
        <div style="text-align: center; margin-bottom: 16px;">
            <h3 class="neon-text" id="playerNameDisplay"></h3>
            <p style="font-size: 12px; color: hsl(120, 20%, 65%);" id="playerClassDisplay"></p>
        </div>
        
        <div>
            <div class="stat-row">
                <span>HP</span>
                <span id="healthDisplay"></span>
            </div>
            <div class="bar-background" style="margin-bottom: 12px;">
                <div id="healthBar" class="health-bar" style="width: 100%;"></div>
            </div>

            <div class="stat-row">
                <span>MP</span>
                <span id="manaDisplay"></span>
            </div>
            <div class="bar-background" style="margin-bottom: 12px;">
                <div id="manaBar" class="mana-bar" style="width: 100%;"></div>
            </div>

            <div class="stat-row">
                <span>Gold:</span>
                <span id="goldDisplay" class="gold-amount"></span>
            </div>
        </div>
    </div>

    <!-- Minimap Panel -->
    <div id="minimapPanel" class="game-ui minimap-panel hidden" onclick="toggleMinimap()">
        <h3 class="neon-text" style="margin-bottom: 8px; font-size: 14px;">Map</h3>
        <canvas id="minimapCanvas" class="minimap-canvas" width="200" height="120"></canvas>
        <div class="player-count-box">
            <span class="neon-text">Online Players (<span id="playerCount">0</span>)</span>
        </div>
    </div>

    <!-- Chat Panel -->
    <div id="chatPanel" class="game-ui chat-panel hidden">
        <h3 class="neon-text chat-toggle" style="margin-bottom: 12px;" onclick="toggleChat()">Chat <span id="chatToggleIcon">▲</span></h3>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type a message...">
            <button id="sendButton">Send</button>
        </div>
    </div>

    <!-- Controls Panel -->
    <div id="controlsPanel" class="game-ui controls-panel hidden">
        <button class="close-button" onclick="closeControls()">×</button>
        <h3 class="neon-text" style="margin-bottom: 12px;">Controls</h3>
        <div class="controls-text">
            <div>🎮 <strong>WASD</strong> or <strong>Arrow Keys</strong> - Move</div>
            <div>⚡ <strong>E</strong> or <strong>Space</strong> - Interact with NPCs</div>
            <div>💬 <strong>Enter</strong> - Send chat message</div>
            <div>🌟 Walk near NPCs to interact with them</div>
        </div>
    </div>

    <!-- Interaction Dialog -->
    <div id="interactionOverlay" class="overlay hidden"></div>
    <div id="interactionDialog" class="interaction-dialog hidden">
        <h3 class="neon-text" id="npcName"></h3>
        <p id="npcDialogue" style="margin: 16px 0;"></p>
        <div id="shopItems" class="shop-items hidden"></div>
        <div style="text-align: right; margin-top: 16px;">
            <button id="closeDialog">Close</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Test that JavaScript is working
        console.log('=== JAVASCRIPT LOADED ===');
        
        // Supabase Configuration
        const SUPABASE_URL = "https://yxtihsvpirmpmrffdbnt.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4dGloc3ZwaXJtcG1yZmZkYm50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzUwMjAsImV4cCI6MjA3MDExMTAyMH0.0edpLL1XlfmyTEYfqyGnaUt0kMBcwwnjt0XlORrHRwQ";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Game Constants
        const TILE_SIZE = 32;
        const MOVE_SPEED = 180;  // Increased speed for smoother movement
        const UPDATE_INTERVAL = 16;  // 60fps update rate for smooth movement
        const WORLD_WIDTH = 2000;  // MASSIVE OPEN WORLD - 20x bigger than before
        const WORLD_HEIGHT = 1500;  // GIGANTIC MAP for endless exploration
        const INTERPOLATION_SPEED = 8;  // For smooth position interpolation

        // Game State
        let gameState = {
            players: {},
            messages: [],
            currentPlayer: null,
            isConnected: false,
            keys: {},
            animationFrame: 0,
            lastUpdate: Date.now(),
            interactionTarget: null,
            lastPositionUpdate: 0,
            renderOptimizations: {
                skipFrames: 0,
                maxSkipFrames: 2
            }
        };

        // World Data
        const TILES = {
            grass: { id: 'grass', type: 'grass', walkable: true, color: '#10b981' },
            stone: { id: 'stone', type: 'stone', walkable: true, color: '#64748b' },
            water: { id: 'water', type: 'water', walkable: false, color: '#3b82f6' },
            dirt: { id: 'dirt', type: 'dirt', walkable: true, color: '#a3540f' },
            wood: { id: 'wood', type: 'wood', walkable: false, color: '#92400e' },
            roof: { id: 'roof', type: 'roof', walkable: false, color: '#7c2d12' },
            door: { id: 'door', type: 'door', walkable: true, color: '#fbbf24' },
            wall: { id: 'wall', type: 'wall', walkable: false, color: '#525252' },
            floor: { id: 'floor', type: 'floor', walkable: true, color: '#d6d3d1' }
        };

        const BUILDINGS = [
            // === MAIN CAPITAL CITY (CENTER) - Dragonheart City ===
            { id: 'capital-castle', name: 'Royal Castle', type: 'castle', x: 980, y: 720, width: 40, height: 30, entrance: { x: 1000, y: 750 }, icon: '🏰', description: 'Seat of the kingdom' },
            { id: 'capital-weapon-shop', name: 'Iron & Steel Armory', type: 'shop', x: 960, y: 770, width: 12, height: 10, entrance: { x: 966, y: 780 }, icon: '⚔️', description: 'Finest weapons and armor' },
            { id: 'capital-potion-shop', name: 'Mystic Potions', type: 'shop', x: 975, y: 770, width: 12, height: 10, entrance: { x: 981, y: 780 }, icon: '🧪', description: 'Magical potions and remedies' },
            { id: 'capital-magic-shop', name: 'Arcane Emporium', type: 'shop', x: 990, y: 770, width: 12, height: 10, entrance: { x: 996, y: 780 }, icon: '🔮', description: 'Mystical artifacts and scrolls' },
            { id: 'capital-jewelry-shop', name: 'Golden Crown Jewelers', type: 'shop', x: 1005, y: 770, width: 12, height: 10, entrance: { x: 1011, y: 780 }, icon: '💎', description: 'Precious gems and jewelry' },
            { id: 'capital-bank', name: 'Royal Treasury', type: 'bank', x: 1020, y: 770, width: 15, height: 12, entrance: { x: 1027, y: 782 }, icon: '🏦', description: 'Store your valuables safely' },
            { id: 'capital-inn', name: 'Golden Griffin Inn', type: 'inn', x: 940, y: 785, width: 15, height: 10, entrance: { x: 947, y: 795 }, icon: '🏨', description: 'Luxurious accommodations' },
            { id: 'capital-tavern', name: 'The Prancing Pony', type: 'tavern', x: 958, y: 785, width: 12, height: 10, entrance: { x: 964, y: 795 }, icon: '🍺', description: 'Best ale in the kingdom' },
            { id: 'capital-arena', name: 'Grand Colosseum', type: 'arena', x: 975, y: 785, width: 30, height: 15, entrance: { x: 990, y: 800 }, icon: '🏟️', description: 'Ultimate combat arena' },
            { id: 'capital-library', name: 'Royal Library', type: 'library', x: 1010, y: 785, width: 20, height: 12, entrance: { x: 1020, y: 797 }, icon: '📚', description: 'Knowledge repository' },
            { id: 'capital-temple', name: 'Cathedral of Light', type: 'temple', x: 1035, y: 785, width: 18, height: 15, entrance: { x: 1044, y: 800 }, icon: '⛪', description: 'Sacred healing grounds' },
            { id: 'capital-auction', name: 'Grand Auction House', type: 'auction', x: 940, y: 800, width: 25, height: 15, entrance: { x: 952, y: 815 }, icon: '🏪', description: 'Premier trading hub' },
            { id: 'capital-guild-hall', name: 'Champions Guild', type: 'guild', x: 970, y: 800, width: 20, height: 12, entrance: { x: 980, y: 812 }, icon: '⚔️', description: 'Elite adventurer headquarters' },

            // === FROSTHOLM (Northern Mountain City) ===
            { id: 'frost-keep', name: 'Frost Keep', type: 'fortress', x: 950, y: 100, width: 35, height: 25, entrance: { x: 967, y: 125 }, icon: '🏰', description: 'Mountain fortress' },
            { id: 'frost-blacksmith1', name: 'Iceforge Smithy', type: 'blacksmith', x: 920, y: 130, width: 15, height: 12, entrance: { x: 927, y: 142 }, icon: '🔨', description: 'Master frost weapons' },
            { id: 'frost-blacksmith2', name: 'Dwarven Forge', type: 'blacksmith', x: 940, y: 130, width: 15, height: 12, entrance: { x: 947, y: 142 }, icon: '⚒️', description: 'Ancient dwarven crafts' },
            { id: 'frost-armorer', name: 'Winterguard Armory', type: 'armorer', x: 960, y: 130, width: 18, height: 12, entrance: { x: 969, y: 142 }, icon: '🛡️', description: 'Cold-resistant armor' },
            { id: 'frost-jeweler', name: 'Crystal Cave Jewelers', type: 'jeweler', x: 980, y: 130, width: 12, height: 10, entrance: { x: 986, y: 140 }, icon: '💎', description: 'Ice crystals and gems' },
            { id: 'frost-alchemist', name: 'Frostbite Alchemy', type: 'alchemist', x: 995, y: 130, width: 12, height: 10, entrance: { x: 1001, y: 140 }, icon: '🧪', description: 'Cold climate potions' },
            { id: 'frost-inn1', name: 'Icewind Tavern', type: 'inn', x: 1010, y: 130, width: 15, height: 10, entrance: { x: 1017, y: 140 }, icon: '🏨', description: 'Warm hearth inn' },
            { id: 'frost-inn2', name: 'Frostbeard Lodge', type: 'inn', x: 1030, y: 130, width: 12, height: 10, entrance: { x: 1036, y: 140 }, icon: '🏠', description: 'Cozy mountain lodge' },
            { id: 'frost-bank', name: 'Frozen Vault', type: 'bank', x: 920, y: 145, width: 12, height: 10, entrance: { x: 926, y: 155 }, icon: '🏦', description: 'Secure ice vaults' },
            { id: 'frost-stable', name: 'Wolf Riders Stable', type: 'stable', x: 935, y: 145, width: 18, height: 12, entrance: { x: 944, y: 157 }, icon: '🐺', description: 'Arctic wolf mounts' },
            { id: 'frost-temple', name: 'Temple of Winter', type: 'temple', x: 955, y: 145, width: 15, height: 12, entrance: { x: 962, y: 157 }, icon: '❄️', description: 'Ice goddess shrine' },
            { id: 'frost-tower', name: 'Glacier Tower', type: 'tower', x: 975, y: 145, width: 10, height: 15, entrance: { x: 980, y: 160 }, icon: '🗼', description: 'Mage research facility' },
            { id: 'frost-portal', name: 'Frostpeak Portal', type: 'portal', x: 990, y: 145, width: 8, height: 8, entrance: { x: 994, y: 153 }, icon: '🌀', description: 'Fast travel nexus' },

            // === SUNSPIRE (Southern Desert Metropolis) ===
            { id: 'sun-palace', name: 'Palace of Sands', type: 'palace', x: 1050, y: 1300, width: 40, height: 30, entrance: { x: 1070, y: 1330 }, icon: '🏛️', description: 'Desert emperor\'s palace' },
            { id: 'sun-bazaar', name: 'Grand Bazaar', type: 'market', x: 1000, y: 1340, width: 30, height: 20, entrance: { x: 1015, y: 1360 }, icon: '🏬', description: 'Massive trading center' },
            { id: 'sun-spice-shop', name: 'Exotic Spice Traders', type: 'shop', x: 1100, y: 1340, width: 12, height: 10, entrance: { x: 1106, y: 1350 }, icon: '🌶️', description: 'Rare spices and herbs' },
            { id: 'sun-silk-shop', name: 'Silk Road Merchants', type: 'shop', x: 1115, y: 1340, width: 12, height: 10, entrance: { x: 1121, y: 1350 }, icon: '🧵', description: 'Fine silks and fabrics' },
            { id: 'sun-weapon-shop', name: 'Scimitar Smithy', type: 'shop', x: 1130, y: 1340, width: 12, height: 10, entrance: { x: 1136, y: 1350 }, icon: '🗡️', description: 'Curved blade specialists' },
            { id: 'sun-jeweler1', name: 'Desert Gems', type: 'jeweler', x: 1145, y: 1340, width: 12, height: 10, entrance: { x: 1151, y: 1350 }, icon: '💰', description: 'Precious desert stones' },
            { id: 'sun-jeweler2', name: 'Golden Oasis', type: 'jeweler', x: 1160, y: 1340, width: 12, height: 10, entrance: { x: 1166, y: 1350 }, icon: '🏺', description: 'Ancient treasure dealers' },
            { id: 'sun-stable1', name: 'Camel Caravan', type: 'stable', x: 1000, y: 1365, width: 20, height: 12, entrance: { x: 1010, y: 1377 }, icon: '🐪', description: 'Desert mount specialists' },
            { id: 'sun-stable2', name: 'Flying Carpet Emporium', type: 'stable', x: 1025, y: 1365, width: 15, height: 12, entrance: { x: 1032, y: 1377 }, icon: '🪄', description: 'Magical transport' },
            { id: 'sun-inn1', name: 'Oasis Rest', type: 'inn', x: 1045, y: 1365, width: 15, height: 10, entrance: { x: 1052, y: 1375 }, icon: '🌴', description: 'Desert oasis inn' },
            { id: 'sun-inn2', name: 'Mirage Palace', type: 'inn', x: 1065, y: 1365, width: 18, height: 12, entrance: { x: 1074, y: 1377 }, icon: '🕌', description: 'Luxury desert hotel' },
            { id: 'sun-bank', name: 'Treasury of Sands', type: 'bank', x: 1090, y: 1365, width: 15, height: 10, entrance: { x: 1097, y: 1375 }, icon: '💰', description: 'Desert wealth storage' },
            { id: 'sun-guild', name: 'Desert Storm Guild', type: 'guild', x: 1110, y: 1365, width: 20, height: 12, entrance: { x: 1120, y: 1377 }, icon: '🌪️', description: 'Elite desert warriors' },

            // === MOONHARBOR (Eastern Coastal Metropolis) ===
            { id: 'moon-lighthouse', name: 'Beacon Tower', type: 'lighthouse', x: 1700, y: 650, width: 12, height: 20, entrance: { x: 1706, y: 670 }, icon: '🏮', description: 'Guides ships safely home' },
            { id: 'moon-harbor', name: 'Grand Harbor', type: 'harbor', x: 1720, y: 650, width: 40, height: 25, entrance: { x: 1740, y: 675 }, icon: '⚓', description: 'Massive shipping port' },
            { id: 'moon-shipyard', name: 'Royal Shipyard', type: 'shipyard', x: 1770, y: 650, width: 30, height: 20, entrance: { x: 1785, y: 670 }, icon: '⛵', description: 'Ship construction facility' },
            { id: 'moon-naval-base', name: 'Naval Command', type: 'military', x: 1805, y: 650, width: 25, height: 15, entrance: { x: 1817, y: 665 }, icon: '🛡️⚓', description: 'Navy headquarters' },
            { id: 'moon-fish-market', name: 'Seafood Market', type: 'market', x: 1700, y: 680, width: 25, height: 15, entrance: { x: 1712, y: 695 }, icon: '🐟', description: 'Fresh catch daily' },
            { id: 'moon-weapon-shop', name: 'Tidewater Arms', type: 'shop', x: 1730, y: 680, width: 12, height: 10, entrance: { x: 1736, y: 690 }, icon: '🔱', description: 'Naval weapons' },
            { id: 'moon-magic-shop', name: 'Sea Witch Emporium', type: 'shop', x: 1745, y: 680, width: 12, height: 10, entrance: { x: 1751, y: 690 }, icon: '🧜‍♀️', description: 'Ocean magic items' },
            { id: 'moon-jewelry', name: 'Pearl Divers Guild', type: 'jeweler', x: 1760, y: 680, width: 12, height: 10, entrance: { x: 1766, y: 690 }, icon: '🦪', description: 'Oceanic treasures' },
            { id: 'moon-inn1', name: 'Salty Sailor Tavern', type: 'inn', x: 1775, y: 680, width: 15, height: 10, entrance: { x: 1782, y: 690 }, icon: '🍻', description: 'Rowdy sailor hangout' },
            { id: 'moon-inn2', name: 'Mermaid\'s Rest', type: 'inn', x: 1795, y: 680, width: 15, height: 10, entrance: { x: 1802, y: 690 }, icon: '🧜‍♀️', description: 'Elegant seaside inn' },
            { id: 'moon-bank', name: 'Oceanic Vault', type: 'bank', x: 1700, y: 700, width: 15, height: 10, entrance: { x: 1707, y: 710 }, icon: '🐚', description: 'Secure sea treasure storage' },
            { id: 'moon-temple', name: 'Temple of Tides', type: 'temple', x: 1720, y: 700, width: 18, height: 15, entrance: { x: 1729, y: 715 }, icon: '🌊', description: 'Sea god worship' },
            { id: 'moon-auction', name: 'Maritime Auction House', type: 'auction', x: 1745, y: 700, width: 20, height: 12, entrance: { x: 1755, y: 712 }, icon: '⚓🏪', description: 'Rare maritime finds' },

            // === IRONHEART (Western Industrial Megacity) ===
            { id: 'iron-factory', name: 'Steam Works', type: 'factory', x: 150, y: 600, width: 35, height: 25, entrance: { x: 167, y: 625 }, icon: '🏭', description: 'Massive industrial complex' },
            { id: 'iron-foundry1', name: 'Great Foundry', type: 'foundry', x: 190, y: 600, width: 25, height: 20, entrance: { x: 202, y: 620 }, icon: '🔥', description: 'Main smelting facility' },
            { id: 'iron-foundry2', name: 'Steel Mill', type: 'foundry', x: 220, y: 600, width: 20, height: 18, entrance: { x: 230, y: 618 }, icon: '⚙️', description: 'Steel production plant' },
            { id: 'iron-armory1', name: 'Military Arsenal', type: 'armory', x: 245, y: 600, width: 20, height: 15, entrance: { x: 255, y: 615 }, icon: '🛡️', description: 'Military equipment supplier' },
            { id: 'iron-armory2', name: 'Heavy Armor Works', type: 'armory', x: 270, y: 600, width: 18, height: 15, entrance: { x: 279, y: 615 }, icon: '⚔️🛡️', description: 'Heavy battle gear' },
            { id: 'iron-engineer-shop', name: 'Gear & Gadgets', type: 'shop', x: 150, y: 630, width: 15, height: 12, entrance: { x: 157, y: 642 }, icon: '⚙️', description: 'Engineering marvels' },
            { id: 'iron-tool-shop', name: 'Master Tools', type: 'shop', x: 170, y: 630, width: 12, height: 10, entrance: { x: 176, y: 640 }, icon: '🔧', description: 'Professional toolmaking' },
            { id: 'iron-workshop', name: 'Inventor\'s Workshop', type: 'workshop', x: 185, y: 630, width: 15, height: 12, entrance: { x: 192, y: 642 }, icon: '🔬', description: 'Experimental crafting' },
            { id: 'iron-inn1', name: 'Steamworks Lodge', type: 'inn', x: 205, y: 630, width: 15, height: 10, entrance: { x: 212, y: 640 }, icon: '🏨', description: 'Industrial worker housing' },
            { id: 'iron-inn2', name: 'Forgemaster\'s Rest', type: 'inn', x: 225, y: 630, width: 15, height: 10, entrance: { x: 232, y: 640 }, icon: '🔨', description: 'Elite crafter lodging' },
            { id: 'iron-bank', name: 'Industrial Bank', type: 'bank', x: 245, y: 630, width: 15, height: 10, entrance: { x: 252, y: 640 }, icon: '🏭', description: 'Corporate treasury' },
            { id: 'iron-guild', name: 'Engineers Guild', type: 'guild', x: 265, y: 630, width: 20, height: 12, entrance: { x: 275, y: 642 }, icon: '⚙️', description: 'Master engineer society' },

            // === SMALLER CITIES AND TOWNS ===
            
            // Verdant Valley (Northwest)
            { id: 'verdant-druid-circle', name: 'Druid Circle', type: 'temple', x: 300, y: 200, width: 20, height: 15, entrance: { x: 310, y: 215 }, icon: '🌿', description: 'Nature worship center' },
            { id: 'verdant-herb-shop', name: 'Nature\'s Bounty', type: 'shop', x: 325, y: 200, width: 12, height: 10, entrance: { x: 331, y: 210 }, icon: '🌱', description: 'Herbal remedies' },
            { id: 'verdant-ranger-post', name: 'Ranger Outpost', type: 'military', x: 280, y: 220, width: 15, height: 10, entrance: { x: 287, y: 230 }, icon: '🏹', description: 'Forest protection force' },
            { id: 'verdant-inn', name: 'Woodland Inn', type: 'inn', x: 300, y: 220, width: 12, height: 8, entrance: { x: 306, y: 228 }, icon: '🏠', description: 'Peaceful forest lodge' },

            // Shadowmere (Southeast)
            { id: 'shadow-necro-tower', name: 'Necromancer Tower', type: 'tower', x: 1400, y: 1200, width: 10, height: 18, entrance: { x: 1405, y: 1218 }, icon: '💀', description: 'Dark magic research' },
            { id: 'shadow-dark-shop', name: 'Forbidden Arts', type: 'shop', x: 1420, y: 1200, width: 12, height: 10, entrance: { x: 1426, y: 1210 }, icon: '🌑', description: 'Dark magic items' },
            { id: 'shadow-cult-temple', name: 'Shadow Cult Temple', type: 'temple', x: 1380, y: 1220, width: 15, height: 12, entrance: { x: 1387, y: 1232 }, icon: '👁️', description: 'Mysterious cult worship' },

            // Dwarven Stronghold (Southwest)
            { id: 'dwarf-hall', name: 'Great Hall of Kings', type: 'hall', x: 300, y: 1000, width: 30, height: 20, entrance: { x: 315, y: 1020 }, icon: '👑', description: 'Dwarven royal seat' },
            { id: 'dwarf-mine', name: 'Deepdelve Mines', type: 'mine', x: 200, y: 1000, width: 25, height: 15, entrance: { x: 212, y: 1015 }, icon: '⛏️', description: 'Rich mining operation' },
            { id: 'dwarf-forge', name: 'Ancestral Forge', type: 'blacksmith', x: 250, y: 980, width: 18, height: 15, entrance: { x: 259, y: 995 }, icon: '🔥', description: 'Ancient dwarven crafting' },
            { id: 'dwarf-brewery', name: 'Golden Ale Brewery', type: 'tavern', x: 280, y: 980, width: 15, height: 12, entrance: { x: 287, y: 992 }, icon: '🍺', description: 'Famous dwarven ales' },

            // Elven Enclave (Far Northeast)
            { id: 'elf-tree-palace', name: 'Starlight Palace', type: 'palace', x: 1600, y: 150, width: 25, height: 20, entrance: { x: 1612, y: 170 }, icon: '🌟', description: 'Elven royal court' },
            { id: 'elf-magic-academy', name: 'Moonweave Academy', type: 'academy', x: 1630, y: 150, width: 20, height: 15, entrance: { x: 1640, y: 165 }, icon: '📖', description: 'Elven magic school' },
            { id: 'elf-bow-shop', name: 'Silverstring Bowyers', type: 'shop', x: 1580, y: 175, width: 12, height: 10, entrance: { x: 1586, y: 185 }, icon: '🏹', description: 'Masterwork elven bows' },
            { id: 'elf-garden', name: 'Starlight Gardens', type: 'garden', x: 1600, y: 175, width: 20, height: 15, entrance: { x: 1610, y: 190 }, icon: '🌸', description: 'Magical botanical sanctuary' },

            // Flying City (Center North)
            { id: 'sky-platform', name: 'Sky Platform', type: 'platform', x: 1000, y: 300, width: 30, height: 25, entrance: { x: 1015, y: 325 }, icon: '☁️', description: 'Floating sky city' },
            { id: 'sky-wind-shop', name: 'Wind Walker Gear', type: 'shop', x: 980, y: 280, width: 12, height: 10, entrance: { x: 986, y: 290 }, icon: '🌪️', description: 'Flying equipment' },
            { id: 'sky-air-temple', name: 'Temple of Storms', type: 'temple', x: 1020, y: 280, width: 15, height: 12, entrance: { x: 1027, y: 292 }, icon: '⚡', description: 'Sky god worship' },

            // Volcano Forge (Far Southwest)
            { id: 'volcano-forge', name: 'Dragonfire Forge', type: 'forge', x: 100, y: 1300, width: 20, height: 18, entrance: { x: 110, y: 1318 }, icon: '🌋', description: 'Volcanic smithing' },
            { id: 'volcano-dragon-lair', name: 'Dragon\'s Lair', type: 'lair', x: 130, y: 1300, width: 25, height: 20, entrance: { x: 142, y: 1320 }, icon: '🐉', description: 'Ancient dragon home' },

            // Underwater City (Southeast Coast)
            { id: 'aqua-dome', name: 'Aquatic Dome', type: 'dome', x: 1700, y: 1200, width: 30, height: 25, entrance: { x: 1715, y: 1225 }, icon: '🫧', description: 'Underwater city bubble' },
            { id: 'aqua-coral-shop', name: 'Coral Crafters', type: 'shop', x: 1740, y: 1200, width: 12, height: 10, entrance: { x: 1746, y: 1210 }, icon: '🪸', description: 'Underwater materials' },

            // Nomad Camps and Trading Posts
            { id: 'nomad-camp1', name: 'Desert Wanderer Camp', type: 'camp', x: 800, y: 1100, width: 15, height: 10, entrance: { x: 807, y: 1110 }, icon: '⛺', description: 'Nomadic trading post' },
            { id: 'nomad-camp2', name: 'Steppe Riders Camp', type: 'camp', x: 1300, y: 800, width: 15, height: 10, entrance: { x: 1307, y: 810 }, icon: '🏕️', description: 'Horse nomad settlement' },
            { id: 'trading-post1', name: 'Crossroads Trading', type: 'trading', x: 600, y: 600, width: 12, height: 8, entrance: { x: 606, y: 608 }, icon: '🛤️', description: 'Major trade route hub' },
            { id: 'trading-post2', name: 'Mountain Pass Trading', type: 'trading', x: 700, y: 300, width: 12, height: 8, entrance: { x: 706, y: 308 }, icon: '🏔️', description: 'Mountain route stop' },

            // Ancient Ruins and Dungeons
            { id: 'ancient-temple1', name: 'Temple of the Ancients', type: 'ruin', x: 400, y: 400, width: 20, height: 15, entrance: { x: 410, y: 415 }, icon: '🏛️', description: 'Mysterious ancient structure' },
            { id: 'ancient-pyramid', name: 'Lost Pyramid', type: 'pyramid', x: 1200, y: 1400, width: 18, height: 18, entrance: { x: 1209, y: 1418 }, icon: '🔺', description: 'Ancient burial site' },
            { id: 'crystal-caves', name: 'Crystal Cave Entrance', type: 'cave', x: 500, y: 200, width: 12, height: 8, entrance: { x: 506, y: 208 }, icon: '💎', description: 'Gem-filled caverns' },
            { id: 'haunted-manor', name: 'Ghostwood Manor', type: 'manor', x: 1500, y: 1000, width: 15, height: 12, entrance: { x: 1507, y: 1012 }, icon: '👻', description: 'Haunted noble estate' },
            { id: 'wizard-tower1', name: 'Tower of Mysteries', type: 'tower', x: 800, y: 400, width: 8, height: 15, entrance: { x: 804, y: 415 }, icon: '🔮', description: 'Abandoned wizard tower' },
            { id: 'bandit-hideout', name: 'Bandit Stronghold', type: 'hideout', x: 350, y: 800, width: 18, height: 12, entrance: { x: 359, y: 812 }, icon: '💰', description: 'Outlaw fortress' },

            // Specialized Districts and Areas
            { id: 'arena-district', name: 'Gladiator District', type: 'district', x: 900, y: 900, width: 40, height: 30, entrance: { x: 920, y: 930 }, icon: '⚔️', description: 'Combat training grounds' },
            { id: 'magic-district', name: 'Arcane Quarter', type: 'district', x: 1100, y: 600, width: 35, height: 25, entrance: { x: 1117, y: 625 }, icon: '✨', description: 'Magic user haven' },
            { id: 'crafting-district', name: 'Artisan Quarter', type: 'district', x: 600, y: 800, width: 30, height: 20, entrance: { x: 615, y: 820 }, icon: '🛠️', description: 'Master craftsmen area' }
        ];

        // === COMPREHENSIVE GAME ITEMS DATABASE ===
        const GAME_ITEMS = {
            // WEAPONS - Melee
            'rusty-sword': { name: 'Rusty Sword', type: 'weapon', price: 15, description: 'A worn but serviceable blade', icon: '🗡️', rarity: 'common' },
            'iron-sword': { name: 'Iron Sword', type: 'weapon', price: 100, description: 'A sturdy iron blade', icon: '⚔️', rarity: 'common' },
            'steel-sword': { name: 'Steel Sword', type: 'weapon', price: 250, description: 'Sharp and durable steel', icon: '🗡️', rarity: 'uncommon' },
            'silver-sword': { name: 'Silver Sword', type: 'weapon', price: 500, description: 'Blessed silver blade', icon: '✨⚔️', rarity: 'rare' },
            'mithril-sword': { name: 'Mithril Sword', type: 'weapon', price: 1200, description: 'Lightweight elven steel', icon: '🌟⚔️', rarity: 'epic' },
            'dragon-slayer': { name: 'Dragon Slayer', type: 'weapon', price: 5000, description: 'Legendary dragon-killing blade', icon: '🐉⚔️', rarity: 'legendary' },
            'frost-blade': { name: 'Frost Blade', type: 'weapon', price: 300, description: 'Ice-cold steel that never dulls', icon: '❄️⚔️', rarity: 'rare' },
            'flame-sword': { name: 'Flame Sword', type: 'weapon', price: 400, description: 'Burns with eternal fire', icon: '🔥⚔️', rarity: 'rare' },
            'void-blade': { name: 'Void Blade', type: 'weapon', price: 800, description: 'Cuts through reality itself', icon: '🌑⚔️', rarity: 'epic' },
            'crystal-sword': { name: 'Crystal Sword', type: 'weapon', price: 600, description: 'Forged from pure crystal', icon: '💎⚔️', rarity: 'rare' },
            'storm-blade': { name: 'Storm Blade', type: 'weapon', price: 700, description: 'Crackling with lightning', icon: '⚡⚔️', rarity: 'epic' },
            'shadow-fang': { name: 'Shadow Fang', type: 'weapon', price: 450, description: 'Strikes from the darkness', icon: '🌙⚔️', rarity: 'rare' },

            // WEAPONS - Ranged
            'hunting-bow': { name: 'Hunting Bow', type: 'weapon', price: 80, description: 'Simple but effective bow', icon: '🏹', rarity: 'common' },
            'longbow': { name: 'Longbow', type: 'weapon', price: 200, description: 'Excellent range and power', icon: '🏹', rarity: 'uncommon' },
            'elven-bow': { name: 'Elven Bow', type: 'weapon', price: 600, description: 'Masterwork elven craftsmanship', icon: '🌟🏹', rarity: 'rare' },
            'crossbow': { name: 'Crossbow', type: 'weapon', price: 300, description: 'Mechanical precision weapon', icon: '🎯', rarity: 'uncommon' },
            'magic-wand': { name: 'Magic Wand', type: 'weapon', price: 150, description: 'Channels magical energy', icon: '🪄', rarity: 'uncommon' },
            'staff-of-power': { name: 'Staff of Power', type: 'weapon', price: 800, description: 'Amplifies magical abilities', icon: '🔮', rarity: 'epic' },

            // ARMOR - Helmets
            'leather-cap': { name: 'Leather Cap', type: 'armor', price: 20, description: 'Basic head protection', icon: '🧢', rarity: 'common' },
            'iron-helmet': { name: 'Iron Helmet', type: 'armor', price: 75, description: 'Solid iron protection', icon: '⛑️', rarity: 'common' },
            'steel-helmet': { name: 'Steel Helmet', type: 'armor', price: 150, description: 'Enhanced steel protection', icon: '🪖', rarity: 'uncommon' },
            'crown-of-kings': { name: 'Crown of Kings', type: 'armor', price: 2000, description: 'Royal magical crown', icon: '👑', rarity: 'legendary' },
            'dragon-helm': { name: 'Dragon Helm', type: 'armor', price: 1500, description: 'Forged from dragon scales', icon: '🐉⛑️', rarity: 'epic' },

            // ARMOR - Body
            'cloth-robe': { name: 'Cloth Robe', type: 'armor', price: 30, description: 'Simple fabric protection', icon: '👘', rarity: 'common' },
            'leather-armor': { name: 'Leather Armor', type: 'armor', price: 80, description: 'Flexible leather protection', icon: '🦺', rarity: 'common' },
            'chainmail': { name: 'Chainmail', type: 'armor', price: 200, description: 'Interlocked metal rings', icon: '🛡️', rarity: 'uncommon' },
            'plate-armor': { name: 'Plate Armor', type: 'armor', price: 500, description: 'Heavy metal plate protection', icon: '🛡️', rarity: 'rare' },
            'dragon-armor': { name: 'Dragon Scale Armor', type: 'armor', price: 3000, description: 'Impenetrable dragon scales', icon: '🐉🛡️', rarity: 'legendary' },
            'mage-robes': { name: 'Mage Robes', type: 'armor', price: 300, description: 'Enchanted spellcaster robes', icon: '🧙‍♂️', rarity: 'uncommon' },
            'assassin-leather': { name: 'Assassin Leather', type: 'armor', price: 400, description: 'Silent and deadly', icon: '🗡️🛡️', rarity: 'rare' },

            // SHIELDS
            'wooden-shield': { name: 'Wooden Shield', type: 'shield', price: 25, description: 'Basic wooden protection', icon: '🛡️', rarity: 'common' },
            'iron-shield': { name: 'Iron Shield', type: 'shield', price: 100, description: 'Solid iron defense', icon: '🛡️', rarity: 'common' },
            'tower-shield': { name: 'Tower Shield', type: 'shield', price: 300, description: 'Massive protective shield', icon: '🛡️', rarity: 'uncommon' },
            'magic-barrier': { name: 'Magic Barrier', type: 'shield', price: 600, description: 'Mystical energy shield', icon: '✨🛡️', rarity: 'rare' },

            // POTIONS - Healing
            'minor-health-potion': { name: 'Minor Health Potion', type: 'potion', price: 15, description: 'Restores 25 HP', icon: '🧪', rarity: 'common' },
            'health-potion': { name: 'Health Potion', type: 'potion', price: 35, description: 'Restores 50 HP', icon: '❤️', rarity: 'common' },
            'greater-health-potion': { name: 'Greater Health Potion', type: 'potion', price: 75, description: 'Restores 100 HP', icon: '💊', rarity: 'uncommon' },
            'super-health-potion': { name: 'Super Health Potion', type: 'potion', price: 150, description: 'Restores 200 HP', icon: '🍀', rarity: 'rare' },
            'elixir-of-life': { name: 'Elixir of Life', type: 'potion', price: 500, description: 'Full health restoration', icon: '⚗️', rarity: 'epic' },

            // POTIONS - Mana
            'minor-mana-potion': { name: 'Minor Mana Potion', type: 'potion', price: 20, description: 'Restores 25 MP', icon: '💙', rarity: 'common' },
            'mana-potion': { name: 'Mana Potion', type: 'potion', price: 40, description: 'Restores 50 MP', icon: '💙', rarity: 'common' },
            'greater-mana-potion': { name: 'Greater Mana Potion', type: 'potion', price: 80, description: 'Restores 100 MP', icon: '🔮', rarity: 'uncommon' },

            // POTIONS - Buffs
            'strength-potion': { name: 'Strength Elixir', type: 'potion', price: 60, description: 'Temporarily increases attack', icon: '💪', rarity: 'uncommon' },
            'speed-potion': { name: 'Speed Potion', type: 'potion', price: 50, description: 'Increases movement speed', icon: '💨', rarity: 'uncommon' },
            'invisibility-potion': { name: 'Invisibility Potion', type: 'potion', price: 200, description: 'Become invisible briefly', icon: '👻', rarity: 'rare' },
            'fire-resistance': { name: 'Fire Resistance Potion', type: 'potion', price: 100, description: 'Protects from fire damage', icon: '🔥', rarity: 'uncommon' },
            'ice-resistance': { name: 'Ice Resistance Potion', type: 'potion', price: 100, description: 'Protects from cold damage', icon: '❄️', rarity: 'uncommon' },

            // ACCESSORIES - Rings
            'copper-ring': { name: 'Copper Ring', type: 'ring', price: 50, description: 'Simple copper band', icon: '💍', rarity: 'common' },
            'silver-ring': { name: 'Silver Ring', type: 'ring', price: 150, description: 'Polished silver ring', icon: '💍', rarity: 'uncommon' },
            'gold-ring': { name: 'Gold Ring', type: 'ring', price: 400, description: 'Valuable golden ring', icon: '💍', rarity: 'rare' },
            'ring-of-power': { name: 'Ring of Power', type: 'ring', price: 1000, description: 'Increases magical ability', icon: '💍✨', rarity: 'epic' },
            'ring-of-protection': { name: 'Ring of Protection', type: 'ring', price: 800, description: 'Reduces damage taken', icon: '💍🛡️', rarity: 'epic' },

            // ACCESSORIES - Amulets
            'lucky-charm': { name: 'Lucky Charm', type: 'amulet', price: 75, description: 'Brings good fortune', icon: '🍀', rarity: 'common' },
            'amulet-of-health': { name: 'Amulet of Health', type: 'amulet', price: 300, description: 'Increases maximum HP', icon: '❤️', rarity: 'rare' },
            'amulet-of-mana': { name: 'Amulet of Mana', type: 'amulet', price: 350, description: 'Increases maximum MP', icon: '💙', rarity: 'rare' },
            'phoenix-pendant': { name: 'Phoenix Pendant', type: 'amulet', price: 2000, description: 'Revives upon death', icon: '🔥🦅', rarity: 'legendary' },

            // CRAFTING MATERIALS
            'iron-ore': { name: 'Iron Ore', type: 'material', price: 10, description: 'Raw iron for smithing', icon: '⛏️', rarity: 'common' },
            'steel-ingot': { name: 'Steel Ingot', type: 'material', price: 25, description: 'Refined steel bar', icon: '🔨', rarity: 'common' },
            'mithril-ore': { name: 'Mithril Ore', type: 'material', price: 100, description: 'Rare magical metal', icon: '✨⛏️', rarity: 'rare' },
            'dragon-scale': { name: 'Dragon Scale', type: 'material', price: 500, description: 'Incredibly tough scale', icon: '🐉', rarity: 'epic' },
            'phoenix-feather': { name: 'Phoenix Feather', type: 'material', price: 800, description: 'Magical phoenix plume', icon: '🪶', rarity: 'epic' },
            'crystal-shard': { name: 'Crystal Shard', type: 'material', price: 150, description: 'Magical crystal fragment', icon: '💎', rarity: 'uncommon' },
            'moonstone': { name: 'Moonstone', type: 'material', price: 300, description: 'Glowing lunar stone', icon: '🌙', rarity: 'rare' },
            'stardust': { name: 'Stardust', type: 'material', price: 1000, description: 'Celestial crafting material', icon: '⭐', rarity: 'legendary' },

            // FOOD & CONSUMABLES
            'bread': { name: 'Bread', type: 'food', price: 2, description: 'Simple bread loaf', icon: '🍞', rarity: 'common' },
            'cheese': { name: 'Cheese', type: 'food', price: 5, description: 'Aged cheese wheel', icon: '🧀', rarity: 'common' },
            'meat': { name: 'Cooked Meat', type: 'food', price: 8, description: 'Hearty roasted meat', icon: '🥩', rarity: 'common' },
            'apple': { name: 'Fresh Apple', type: 'food', price: 3, description: 'Crisp red apple', icon: '🍎', rarity: 'common' },
            'wine': { name: 'Fine Wine', type: 'drink', price: 25, description: 'Vintage wine bottle', icon: '🍷', rarity: 'uncommon' },
            'ale': { name: 'Dwarven Ale', type: 'drink', price: 10, description: 'Strong dwarven brew', icon: '🍺', rarity: 'common' },
            'elven-bread': { name: 'Elven Lembas', type: 'food', price: 50, description: 'Sustains for days', icon: '🌿🍞', rarity: 'rare' },

            // TOOLS & UTILITIES
            'pickaxe': { name: 'Pickaxe', type: 'tool', price: 40, description: 'Mining tool', icon: '⛏️', rarity: 'common' },
            'hammer': { name: 'Hammer', type: 'tool', price: 30, description: 'Crafting tool', icon: '🔨', rarity: 'common' },
            'rope': { name: 'Rope', type: 'tool', price: 15, description: '50 feet of strong rope', icon: '🪢', rarity: 'common' },
            'torch': { name: 'Torch', type: 'tool', price: 5, description: 'Provides light', icon: '🕯️', rarity: 'common' },
            'lockpick-set': { name: 'Lockpick Set', type: 'tool', price: 100, description: 'For opening locks', icon: '🗝️', rarity: 'uncommon' },
            'teleport-scroll': { name: 'Teleport Scroll', type: 'scroll', price: 200, description: 'Instant travel home', icon: '📜', rarity: 'rare' },

            // GEMS & VALUABLES
            'ruby': { name: 'Ruby', type: 'gem', price: 200, description: 'Precious red gemstone', icon: '💎', rarity: 'rare' },
            'sapphire': { name: 'Sapphire', type: 'gem', price: 250, description: 'Beautiful blue gem', icon: '💎', rarity: 'rare' },
            'emerald': { name: 'Emerald', type: 'gem', price: 300, description: 'Vibrant green stone', icon: '💚', rarity: 'rare' },
            'diamond': { name: 'Diamond', type: 'gem', price: 1000, description: 'Ultimate precious stone', icon: '💎', rarity: 'epic' },
            'gold-coin': { name: 'Gold Coin', type: 'currency', price: 1, description: 'Standard currency', icon: '🪙', rarity: 'common' },

            // SPECIAL & QUEST ITEMS
            'ancient-key': { name: 'Ancient Key', type: 'key', price: 0, description: 'Opens ancient doors', icon: '🗝️', rarity: 'quest' },
            'dragon-egg': { name: 'Dragon Egg', type: 'special', price: 10000, description: 'Legendary dragon egg', icon: '🥚', rarity: 'legendary' },
            'tome-of-wisdom': { name: 'Tome of Wisdom', type: 'book', price: 500, description: 'Increases experience gain', icon: '📚', rarity: 'epic' },
            'map-fragment': { name: 'Treasure Map Fragment', type: 'map', price: 100, description: 'Part of a treasure map', icon: '🗺️', rarity: 'uncommon' },
            'soul-gem': { name: 'Soul Gem', type: 'gem', price: 5000, description: 'Contains trapped souls', icon: '💜', rarity: 'legendary' }
        };

        const NPCS = [
            // === DRAGONHEART CITY (CAPITAL) NPCs ===
            // Royal District
            { id: 'king-aldric', name: 'King Aldric the Wise', type: 'royalty', x: 1000, y: 735, sprite: '👑', color: '#FFD700',
              dialogue: ["Welcome to my kingdom, brave adventurer!", "The realm faces great challenges ahead.", "Prove yourself worthy and great rewards await!"],
              quests: ['save-the-princess', 'unite-the-kingdoms', 'dragon-threat'] },
            { id: 'queen-isabella', name: 'Queen Isabella', type: 'royalty', x: 1005, y: 735, sprite: '👸', color: '#FFB6C1',
              dialogue: ["The people need heroes like you.", "My heart aches for those in need.", "Please help bring peace to our lands."],
              quests: ['heal-the-sick', 'feed-the-hungry'] },
            { id: 'court-wizard', name: 'Archmage Merlin', type: 'wizard', x: 995, y: 740, sprite: '🧙‍♂️', color: '#8A2BE2',
              dialogue: ["The magical arts require dedication.", "Ancient knowledge awaits the worthy.", "Beware the growing darkness!"],
              shop: ['magic-wand', 'staff-of-power', 'mana-potion', 'teleport-scroll', 'tome-of-wisdom'],
              quests: ['collect-stardust', 'magical-research'] },
            { id: 'royal-guard', name: 'Captain Marcus', type: 'guard', x: 990, y: 740, sprite: '🛡️', color: '#B22222',
              dialogue: ["The kingdom's defense is my duty.", "Train hard, fight harder!", "Only the strong protect the weak."],
              quests: ['guard-training', 'eliminate-bandits'] },
            
            // Merchant Quarter
            { id: 'master-blacksmith', name: 'Gareth the Forge-Master', type: 'blacksmith', x: 966, y: 775, sprite: '🔨', color: '#8B4513',
              dialogue: ["Welcome to the finest forge in the land!", "Each weapon tells a story.", "Quality over quantity, always!"],
              shop: ['iron-sword', 'steel-sword', 'mithril-sword', 'plate-armor', 'dragon-helm', 'iron-shield', 'tower-shield'] },
            { id: 'master-alchemist', name: 'Luna the Potion-Master', type: 'alchemist', x: 981, y: 775, sprite: '🧪', color: '#9932CC',
              dialogue: ["Alchemy is the art of transformation.", "Every ingredient has its purpose.", "Seek wisdom in the bubbling brew."],
              shop: ['health-potion', 'mana-potion', 'strength-potion', 'speed-potion', 'fire-resistance', 'ice-resistance', 'elixir-of-life'] },
            { id: 'grand-jeweler', name: 'Goldfinger the Jeweler', type: 'jeweler', x: 1011, y: 775, sprite: '💎', color: '#FFD700',
              dialogue: ["Precious stones hold ancient power.", "Beauty and magic intertwined.", "Only the finest gems for heroes!"],
              shop: ['silver-ring', 'gold-ring', 'ring-of-power', 'ring-of-protection', 'amulet-of-health', 'amulet-of-mana', 'phoenix-pendant'] },
            { id: 'magic-merchant', name: 'Mystral the Enchanter', type: 'enchanter', x: 996, y: 775, sprite: '✨', color: '#4B0082',
              dialogue: ["Magic flows through all things.", "Enchantments beyond imagination.", "Power comes with responsibility."],
              shop: ['magic-barrier', 'invisibility-potion', 'crystal-shard', 'moonstone', 'soul-gem'] },

            // Service District
            { id: 'royal-banker', name: 'Treasurer Goldvault', type: 'banker', x: 1027, y: 777, sprite: '🏦', color: '#DAA520',
              dialogue: ["Your wealth is secure with us.", "The royal treasury never fails.", "Gold makes the world turn."] },
            { id: 'grand-innkeeper', name: 'Miriam the Hostess', type: 'innkeeper', x: 947, y: 790, sprite: '🏨', color: '#DDA0DD',
              dialogue: ["Welcome to luxury unmatched!", "Rest fit for kings and heroes.", "Every room tells a story."] },
            { id: 'tavern-keeper', name: 'Barkeep Bill', type: 'tavern', x: 964, y: 790, sprite: '🍺', color: '#CD853F',
              dialogue: ["Best ale in the seven kingdoms!", "Stories flow like wine here.", "Drink up, adventure awaits!"],
              shop: ['ale', 'wine', 'bread', 'cheese', 'meat'] },
            { id: 'head-librarian', name: 'Scholar Bookwise', type: 'librarian', x: 1020, y: 792, sprite: '📚', color: '#2F4F4F',
              dialogue: ["Knowledge is the greatest treasure.", "Seek and ye shall find wisdom.", "Books hold infinite worlds."],
              shop: ['tome-of-wisdom', 'map-fragment', 'ancient-key'] },

            // Arena District
            { id: 'arena-master', name: 'Gladiator Rex', type: 'gladiator', x: 990, y: 792, sprite: '⚔️', color: '#B22222',
              dialogue: ["Prove your worth in combat!", "Only the strong survive here.", "Glory awaits the victorious!"],
              quests: ['arena-champion', 'defeat-monsters'] },
            { id: 'combat-trainer', name: 'Weapon-Master Steel', type: 'trainer', x: 985, y: 795, sprite: '🗡️', color: '#708090',
              dialogue: ["Master your weapons, master yourself.", "Practice makes perfect warriors.", "Every hero needs training."],
              quests: ['weapon-mastery', 'combat-training'] },

            // Quest Givers
            { id: 'quest-herald', name: 'Herald Crier', type: 'herald', x: 1000, y: 750, sprite: '📢', color: '#4169E1',
              dialogue: ["Hear ye! Quests for brave souls!", "Adventure calls to the worthy!", "Fame and fortune await!"],
              quests: ['town-crier', 'spread-news'] },
            { id: 'temple-priest', name: 'High Priest Lightbringer', type: 'priest', x: 1044, y: 792, sprite: '⛪', color: '#F0F8FF',
              dialogue: ["May the light guide your path.", "Healing flows from divine grace.", "The gods watch over heroes."],
              shop: ['elixir-of-life', 'phoenix-pendant', 'lucky-charm'],
              quests: ['divine-mission', 'heal-the-cursed'] },

            // === FROSTHOLM (NORTHERN MOUNTAIN CITY) ===
            // Fortress NPCs
            { id: 'frost-lord', name: 'Lord Frostbeard', type: 'lord', x: 967, y: 112, sprite: '🗡️❄️', color: '#4682B4',
              dialogue: ["The north breeds the strongest warriors!", "Ice runs in our veins!", "Prove yourself against the cold!"],
              quests: ['ice-trial', 'mountain-expedition'] },
            { id: 'ice-witch', name: 'Sorceress Wintermoon', type: 'sorceress', x: 975, y: 115, sprite: '🧙‍♀️', color: '#B0E0E6',
              dialogue: ["The cold holds ancient secrets.", "Ice magic flows through me.", "Embrace the winter's power."],
              shop: ['frost-blade', 'ice-resistance', 'crystal-shard'],
              quests: ['frost-magic', 'winter-solstice'] },

            // Craftsmen
            { id: 'frost-smith1', name: 'Bjorn Iceforge', type: 'blacksmith', x: 927, y: 136, sprite: '🔨', color: '#4682B4',
              dialogue: ["Cold makes steel stronger!", "Northern weapons never break!", "Ice and fire forge perfection!"],
              shop: ['frost-blade', 'ice-resistance', 'steel-sword', 'chainmail', 'iron-helmet'] },
            { id: 'frost-smith2', name: 'Thorin Ironbeard', type: 'blacksmith', x: 947, y: 136, sprite: '⚒️', color: '#2F4F4F',
              dialogue: ["Dwarven craft meets northern ice!", "Ancestral techniques live on!", "Each hammer blow tells a story!"],
              shop: ['mithril-sword', 'dragon-armor', 'tower-shield', 'pickaxe', 'hammer'] },
            { id: 'frost-armorer', name: 'Helga Shieldmaiden', type: 'armorer', x: 969, y: 136, sprite: '🛡️', color: '#B0C4DE',
              dialogue: ["Armor saves lives in battle!", "Protection before glory!", "Let me outfit you properly!"],
              shop: ['leather-armor', 'chainmail', 'plate-armor', 'iron-shield', 'wooden-shield'] },
            { id: 'crystal-jeweler', name: 'Gemcutter Sparkle', type: 'jeweler', x: 986, y: 135, sprite: '💎', color: '#E0E0E0',
              dialogue: ["Ice crystals hold magic power!", "Gems from deep mountain caves!", "Beauty forged in eternal cold!"],
              shop: ['crystal-shard', 'moonstone', 'silver-ring', 'amulet-of-mana', 'ruby', 'sapphire'] },

            // Services
            { id: 'frost-innkeeper1', name: 'Innkeeper Warmheart', type: 'innkeeper', x: 1017, y: 135, sprite: '🏨', color: '#CD853F',
              dialogue: ["Come warm yourself by our fire!", "Hot meals in the cold north!", "Comfort against the winter winds!"] },
            { id: 'frost-innkeeper2', name: 'Lodge-Master Hearthstone', type: 'innkeeper', x: 1036, y: 135, sprite: '🏠', color: '#8B4513',
              dialogue: ["Mountain hospitality at its finest!", "Every traveler finds warmth here!", "Stories shared by crackling fires!"] },
            { id: 'frost-banker', name: 'Vault-Keeper Goldfreeze', type: 'banker', x: 926, y: 150, sprite: '🏦', color: '#1E90FF',
              dialogue: ["Your treasures stay frozen in time!", "Ice-locked vaults never thaw!", "Security cold as winter itself!"] },
            { id: 'wolf-trainer', name: 'Beast-Master Fenris', type: 'stable', x: 944, y: 151, sprite: '🐺', color: '#696969',
              dialogue: ["Wolves make the best companions!", "Loyal, fierce, and swift!", "Choose your pack mate wisely!"],
              shop: ['wolf-mount', 'beast-training', 'meat'] },

            // === SUNSPIRE (SOUTHERN DESERT METROPOLIS) ===
            // Palace NPCs
            { id: 'desert-emperor', name: 'Emperor Solaris', type: 'emperor', x: 1070, y: 1315, sprite: '👑', color: '#FFD700',
              dialogue: ["The desert sun blesses all!", "Gold flows like sand here!", "Trade and prosperity for all!"],
              quests: ['desert-caravan', 'oasis-protection'] },
            { id: 'sun-priestess', name: 'Solar Priestess Astra', type: 'priestess', x: 1075, y: 1320, sprite: '☀️', color: '#FFA500',
              dialogue: ["The sun god watches over us!", "Light banishes all darkness!", "Solar blessings upon you!"],
              shop: ['elixir-of-life', 'phoenix-pendant', 'phoenix-feather'],
              quests: ['sun-pilgrimage', 'light-ritual'] },

            // Grand Bazaar
            { id: 'spice-merchant', name: 'Merchant Prince Zahir', type: 'merchant', x: 1015, y: 1350, sprite: '🌶️', color: '#FF6347',
              dialogue: ["Spices from across the world!", "Taste the exotic flavors!", "Every spice tells a story!"],
              shop: ['spice-potion', 'fire-resistance', 'strength-potion', 'speed-potion'] },
            { id: 'silk-trader', name: 'Silk-Weaver Yasmin', type: 'trader', x: 1020, y: 1355, sprite: '🧵', color: '#DDA0DD',
              dialogue: ["Finest silks in all the lands!", "Luxury woven with golden thread!", "Fabric fit for royalty!"],
              shop: ['silk-robes', 'mage-robes', 'cloth-robe'] },
            { id: 'gem-dealer', name: 'Jewel-Master Aladdin', type: 'dealer', x: 1025, y: 1360, sprite: '💰', color: '#DAA520',
              dialogue: ["Treasures from ancient tombs!", "Gems that capture starlight!", "Riches beyond imagination!"],
              shop: ['ruby', 'sapphire', 'emerald', 'diamond', 'gold-ring', 'phoenix-pendant'] },

            // Specialized Shops
            { id: 'scimitar-smith', name: 'Blade-Master Rajesh', type: 'weaponsmith', x: 1136, y: 1345, sprite: '🗡️', color: '#C0392B',
              dialogue: ["Curved blades of desert steel!", "Sharp as scorpion stings!", "Weapons forged in solar fire!"],
              shop: ['scimitar', 'curved-dagger', 'desert-armor'] },
            { id: 'desert-jeweler1', name: 'Sand-Crystal Carver', type: 'jeweler', x: 1151, y: 1345, sprite: '💎', color: '#F4A460',
              dialogue: ["Desert stones hold sun's power!", "Gems born from endless heat!", "Beauty from the harsh sands!"],
              shop: ['ruby', 'gold-ring', 'amulet-of-health', 'desert-gems'] },
            { id: 'desert-jeweler2', name: 'Oasis Treasure Hunter', type: 'treasure', x: 1166, y: 1345, sprite: '🏺', color: '#DEB887',
              dialogue: ["Ancient treasures from lost ruins!", "Every piece has a legend!", "Mysteries of the old kingdom!"],
              shop: ['ancient-key', 'treasure-map', 'soul-gem', 'stardust'] },

            // Stables and Transport
            { id: 'camel-master', name: 'Caravan-Master Hassan', type: 'stable', x: 1010, y: 1372, sprite: '🐪', color: '#D2B48C',
              dialogue: ["Desert ships for long journeys!", "Camels never fail the worthy!", "Cross any wasteland in comfort!"],
              shop: ['camel-mount', 'desert-supplies', 'water-rations'] },
            { id: 'carpet-merchant', name: 'Flying Carpet Dealer', type: 'magic', x: 1032, y: 1372, sprite: '🪄', color: '#9370DB',
              dialogue: ["Soar above the desert sands!", "Magic carpets of ancient power!", "The sky calls to adventurers!"],
              shop: ['flying-carpet', 'wind-magic', 'teleport-scroll'] },

            // === MOONHARBOR (EASTERN COASTAL METROPOLIS) ===
            // Harbor Authority
            { id: 'harbor-master', name: 'Admiral Stormwind', type: 'admiral', x: 1740, y: 662, sprite: '⚓', color: '#1E90FF',
              dialogue: ["Welcome to the greatest port!", "The seas connect all lands!", "Adventure awaits on the waves!"],
              quests: ['sea-exploration', 'pirate-hunting'] },
            { id: 'lighthouse-keeper', name: 'Beacon-Keeper Luminous', type: 'keeper', x: 1706, y: 660, sprite: '🏮', color: '#FFD700',
              dialogue: ["I guide ships safely home.", "Light conquers the darkest night.", "Every vessel needs guidance."],
              quests: ['lighthouse-maintenance', 'rescue-mission'] },

            // Maritime Merchants
            { id: 'sea-captain', name: 'Captain Saltbeard', type: 'captain', x: 1740, y: 667, sprite: '⚓', color: '#2F4F4F',
              dialogue: ["The sea provides all treasures!", "Every wave brings adventure!", "Sailor's life for me!"],
              shop: ['pearl-sword', 'sea-armor', 'compass', 'rope', 'sail-cloth'] },
            { id: 'fish-monger', name: 'Fresh-Catch Fisherman', type: 'fishmonger', x: 1712, y: 687, sprite: '🐟', color: '#20B2AA',
              dialogue: ["Fresh from the morning catch!", "Sea's bounty feeds the world!", "Fish so fresh they're still swimming!"],
              shop: ['fresh-fish', 'sea-rations', 'fishing-net', 'fishing-rod'] },
            { id: 'naval-weapons', name: 'Tide-Forger Aquarius', type: 'weaponsmith', x: 1736, y: 685, sprite: '🔱', color: '#4682B4',
              dialogue: ["Weapons blessed by sea gods!", "Naval steel never rusts!", "Forge of the eternal tides!"],
              shop: ['trident', 'naval-sword', 'sea-armor', 'water-magic'] },
            { id: 'sea-witch', name: 'Sorceress Coral', type: 'witch', x: 1751, y: 685, sprite: '🧜‍♀️', color: '#008B8B',
              dialogue: ["Ocean's magic flows through me!", "Depths hold ancient secrets!", "Tidal power at your service!"],
              shop: ['water-magic', 'sea-potion', 'pearl-jewelry', 'ocean-scroll'] },
            { id: 'pearl-diver', name: 'Deep-Sea Treasure Hunter', type: 'diver', x: 1766, y: 685, sprite: '🦪', color: '#F0F8FF',
              dialogue: ["Treasures from ocean's depths!", "Pearls worth a kingdom's ransom!", "The deep sea tells no lies!"],
              shop: ['pearl-jewelry', 'sea-gems', 'diving-gear', 'ocean-treasures'] },

            // Services
            { id: 'sailor-inn1', name: 'Tavern-Master Rum', type: 'innkeeper', x: 1782, y: 685, sprite: '🍻', color: '#8B4513',
              dialogue: ["Rowdy tales and strong drink!", "Every sailor has a story!", "Drink up, the sea calls tomorrow!"],
              shop: ['rum', 'ale', 'sea-biscuits', 'sailor-tales'] },
            { id: 'sailor-inn2', name: 'Mermaid's Rest Keeper', type: 'innkeeper', x: 1802, y: 685, sprite: '🧜‍♀️', color: '#48D1CC',
              dialogue: ["Elegant rest for weary travelers!", "Dreams of mermaids and treasures!", "Peaceful slumber by the waves!"] },

            // === IRONHEART (WESTERN INDUSTRIAL MEGACITY) ===
            // Industrial Leaders
            { id: 'factory-owner', name: 'Industrialist Steam', type: 'industrialist', x: 167, y: 612, sprite: '🏭', color: '#2F4F4F',
              dialogue: ["Progress through industry!", "Steam powers the future!", "Innovation drives us forward!"],
              quests: ['factory-expansion', 'new-inventions'] },
            { id: 'chief-engineer', name: 'Master Engineer Gearwright', type: 'engineer', x: 172, y: 617, sprite: '⚙️', color: '#708090',
              dialogue: ["Engineering marvels await!", "Every machine has a purpose!", "Precision in all things!"],
              shop: ['gear-weapons', 'mechanical-armor', 'engineering-tools'],
              quests: ['mechanical-repair', 'invention-quest'] },

            // Production Specialists
            { id: 'foundry-master1', name: 'Forge-Boss Molten', type: 'forgemaster', x: 202, y: 610, sprite: '🔥', color: '#B22222',
              dialogue: ["Fire and steel shape the world!", "Heat makes everything possible!", "Molten metal, endless potential!"],
              shop: ['steel-ingot', 'molten-weapons', 'fire-tools'] },
            { id: 'foundry-master2', name: 'Steel-Master Ironheart', type: 'steelmaster', x: 230, y: 609, sprite: '⚙️', color: '#696969',
              dialogue: ["Steel is civilization's backbone!", "Strength through superior metal!", "Industrial might conquers all!"],
              shop: ['steel-weapons', 'industrial-armor', 'steel-tools'] },
            { id: 'arsenal-master1', name: 'War-Master Arsenal', type: 'warmaster', x: 255, y: 607, sprite: '🛡️', color: '#8B0000',
              dialogue: ["Military precision in every piece!", "War demands the finest gear!", "Victory through superior equipment!"],
              shop: ['military-weapons', 'combat-armor', 'tactical-gear'] },
            { id: 'arsenal-master2', name: 'Heavy-Armor Specialist', type: 'armormaster', x: 279, y: 607, sprite: '⚔️🛡️', color: '#556B2F',
              dialogue: ["Heavy armor for heavy battles!", "Protection above all else!", "Let nothing pierce your defense!"],
              shop: ['heavy-armor', 'tower-shields', 'fortress-gear'] },

            // Specialized Shops
            { id: 'gear-gadget-shop', name: 'Inventor Cogwheel', type: 'inventor', x: 157, y: 636, sprite: '⚙️', color: '#FFD700',
              dialogue: ["Gadgets beyond imagination!", "Innovation meets adventure!", "Every tool serves a purpose!"],
              shop: ['mechanical-devices', 'invention-parts', 'gear-accessories'] },
            { id: 'tool-master', name: 'Master Toolsmith', type: 'toolsmith', x: 176, y: 635, sprite: '🔧', color: '#8B4513',
              dialogue: ["Professional tools for professionals!", "Quality that lasts a lifetime!", "Master your craft with our tools!"],
              shop: ['pickaxe', 'hammer', 'crafting-tools', 'repair-kits'] },
            { id: 'workshop-inventor', name: 'Mad Scientist Tesla', type: 'scientist', x: 192, y: 636, sprite: '🔬', color: '#9370DB',
              dialogue: ["Science pushes all boundaries!", "Experiments yield great rewards!", "The future starts in my lab!"],
              shop: ['experimental-gear', 'science-tools', 'prototype-weapons'],
              quests: ['research-mission', 'collect-specimens'] },

            // === SMALLER CITIES AND SPECIALIZED AREAS ===
            
            // Verdant Valley (Nature Haven)
            { id: 'druid-elder', name: 'Arch-Druid Oakenheart', type: 'druid', x: 310, y: 207, sprite: '🌿', color: '#228B22',
              dialogue: ["Nature provides all we need.", "Balance must be maintained.", "The forest speaks to those who listen."],
              shop: ['herbal-remedies', 'nature-magic', 'forest-gear'],
              quests: ['nature-balance', 'forest-protection'] },
            { id: 'herb-master', name: 'Herbalist Willowbark', type: 'herbalist', x: 331, y: 205, sprite: '🌱', color: '#32CD32',
              dialogue: ["Every plant has healing power!", "Nature's pharmacy at your service!", "Herbs grown with ancient wisdom!"],
              shop: ['healing-herbs', 'nature-potions', 'plant-magic'] },
            { id: 'ranger-captain', name: 'Ranger-Chief Hawkeye', type: 'ranger', x: 287, y: 225, sprite: '🏹', color: '#8FBC8F',
              dialogue: ["Protect the wild places!", "Evil must not corrupt nature!", "Swift justice for forest crimes!"],
              shop: ['elven-bow', 'ranger-gear', 'tracking-tools'],
              quests: ['bandit-clearing', 'wildlife-protection'] },

            // Shadowmere (Dark Arts)
            { id: 'necromancer-lord', name: 'Lich-Lord Mortis', type: 'necromancer', x: 1405, y: 1209, sprite: '💀', color: '#4B0082',
              dialogue: ["Death is but another beginning.", "Dark knowledge awaits the bold.", "Power over life and death!"],
              shop: ['dark-magic', 'necromancy-tools', 'soul-gems'],
              quests: ['dark-ritual', 'soul-collection'] },
            { id: 'shadow-merchant', name: 'Dealer in Forbidden Arts', type: 'shadow', x: 1426, y: 1205, sprite: '🌑', color: '#2F2F2F',
              dialogue: ["Forbidden knowledge has a price.", "Darkness serves those who embrace it.", "Power demands sacrifice."],
              shop: ['dark-artifacts', 'shadow-magic', 'cursed-items'] },

            // Dwarven Stronghold
            { id: 'dwarf-king', name: 'King Ironbeard', type: 'dwarf-king', x: 315, y: 1010, sprite: '👑', color: '#B8860B',
              dialogue: ["Welcome to the mountain halls!", "Dwarven craft is unmatched!", "Gold and gems flow like water here!"],
              quests: ['mining-expedition', 'clan-honor'] },
            { id: 'mine-foreman', name: 'Foreman Pickaxe', type: 'foreman', x: 212, y: 1007, sprite: '⛏️', color: '#8B4513',
              dialogue: ["These mines run deep and rich!", "Every tunnel holds treasures!", "Hard work brings great rewards!"],
              shop: ['mining-gear', 'precious-ores', 'gem-tools'],
              quests: ['deep-mining', 'gem-discovery'] },
            { id: 'ancestral-smith', name: 'Ancient-Smith Hammerfall', type: 'ancient-smith', x: 259, y: 987, sprite: '🔥', color: '#B22222',
              dialogue: ["Techniques passed down through ages!", "Every hammer blow echoes history!", "Dwarven steel never breaks!"],
              shop: ['dwarven-weapons', 'ancient-armor', 'runic-gear'] },
            { id: 'brew-master', name: 'Ale-Master Goldenbarrel', type: 'brewer', x: 287, y: 986, sprite: '🍺', color: '#DAA520',
              dialogue: ["Best ale in all the realms!", "Brewed with mountain spring water!", "Each barrel tells a story!"],
              shop: ['dwarven-ale', 'mountain-brew', 'feast-supplies'] },

            // Elven Enclave
            { id: 'elf-king', name: 'King Silvermoon', type: 'elf-king', x: 1612, y: 160, sprite: '🌟', color: '#FFD700',
              dialogue: ["Welcome to our ancient realm.", "Elegance and magic unite here.", "Wisdom flows like starlight."],
              quests: ['elven-heritage', 'starlight-ceremony'] },
            { id: 'magic-teacher', name: 'Arcane-Master Starweaver', type: 'arcane-master', x: 1640, y: 157, sprite: '📖', color: '#8A2BE2',
              dialogue: ["Magic is art and science combined.", "Ancient spells await discovery.", "Knowledge illuminates all paths."],
              shop: ['elven-magic', 'spell-books', 'magic-components'],
              quests: ['magical-studies', 'spell-research'] },
            { id: 'master-bowyer', name: 'Bow-Master Silverstring', type: 'bowyer', x: 1586, y: 180, sprite: '🏹', color: '#32CD32',
              dialogue: ["Elven bows sing in battle!", "Each arrow finds its mark!", "Craft perfected over millennia!"],
              shop: ['elven-bow', 'magic-arrows', 'archer-gear'] },

            // === WANDERING NPCs AND SPECIAL ENCOUNTERS ===
            
            // Nomad Camps
            { id: 'desert-nomad1', name: 'Nomad-Chief Sandstorm', type: 'nomad', x: 807, y: 1105, sprite: '⛺', color: '#DEB887',
              dialogue: ["The desert teaches harsh lessons.", "We follow the ancient paths.", "Trade and survival go hand in hand."],
              shop: ['desert-gear', 'survival-supplies', 'nomad-weapons'] },
            { id: 'steppe-rider', name: 'Horse-Lord Thunder', type: 'horseman', x: 1307, y: 805, sprite: '🏕️', color: '#8B4513',
              dialogue: ["Swift as the wind, strong as stone!", "Horses are our life and freedom!", "The steppe calls to warriors!"],
              shop: ['horse-gear', 'riding-supplies', 'steppe-weapons'] },

            // Trading Posts
            { id: 'crossroads-trader', name: 'Merchant Crossway', type: 'trader', x: 606, y: 604, sprite: '🛤️', color: '#A0522D',
              dialogue: ["All roads lead to profit!", "Best prices at the crossroads!", "Every traveler needs supplies!"],
              shop: ['travel-gear', 'trade-goods', 'route-maps'] },
            { id: 'mountain-trader', name: 'Peak-Trader Alpine', type: 'mountain-trader', x: 706, y: 304, sprite: '🏔️', color: '#708090',
              dialogue: ["Mountain passes hold dangers!", "Stock up before the journey!", "High altitude, high prices!"],
              shop: ['mountain-gear', 'cold-weather-supplies', 'climbing-tools'] },

            // Quest Specialists and Unique NPCs
            { id: 'treasure-hunter1', name: 'Explorer Map-Maker', type: 'explorer', x: 410, y: 407, sprite: '🗺️', color: '#CD853F',
              dialogue: ["Ancient ruins hold great secrets!", "Every map tells a story!", "Adventure awaits the bold!"],
              shop: ['treasure-maps', 'exploration-gear', 'ancient-keys'],
              quests: ['ruin-exploration', 'treasure-hunt'] },
            { id: 'pyramid-guardian', name: 'Sphinx Riddlemaster', type: 'sphinx', x: 1209, y: 1409, sprite: '🔺', color: '#DAA520',
              dialogue: ["Answer my riddles correctly.", "Wisdom opens sealed doors.", "Ancient treasures await the clever."],
              quests: ['riddle-challenge', 'pyramid-trials'] },
            { id: 'crystal-miner', name: 'Gem-Seeker Crystal', type: 'miner', x: 506, y: 204, sprite: '💎', color: '#E6E6FA',
              dialogue: ["Crystals sing with magical power!", "Every gem holds energy!", "Mining magic from deep earth!"],
              shop: ['crystal-gems', 'mining-tools', 'magic-stones'],
              quests: ['crystal-mining', 'gem-collection'] },
            { id: 'ghost-hunter', name: 'Spirit-Bane Exorcist', type: 'exorcist', x: 1507, y: 1006, sprite: '👻', color: '#F0F8FF',
              dialogue: ["Spirits must find peace.", "The restless dead need guidance.", "Light banishes all darkness."],
              shop: ['holy-weapons', 'spirit-tools', 'blessing-items'],
              quests: ['ghost-hunting', 'spirit-cleansing'] },
            { id: 'wizard-hermit', name: 'Hermit-Mage Mysticus', type: 'hermit', x: 804, y: 407, sprite: '🔮', color: '#9370DB',
              dialogue: ["Solitude brings clarity.", "Magic flows strongest in silence.", "Seek wisdom in contemplation."],
              shop: ['rare-magic', 'hermit-potions', 'wisdom-scrolls'],
              quests: ['magical-solitude', 'wisdom-quest'] },
            { id: 'bandit-leader', name: 'Bandit-King Blackheart', type: 'bandit', x: 359, y: 806, sprite: '💰', color: '#8B0000',
              dialogue: ["Join us or face our blades!", "Gold flows to the strongest!", "The road belongs to us!"],
              shop: ['stolen-goods', 'black-market', 'bandit-gear'],
              quests: ['bandit-recruitment', 'highway-robbery'] }
        ];
              dialogue: ["Broke something out here?", "I can patch up most anything!", "Frontier repairs, frontier prices!"]
            },

            // Northeast Outpost  
            { id: 'wayfarer-host', name: 'Innkeeper Martha', type: 'innkeeper', x: 1605, y: 404, sprite: '🏨', color: '#ec4899',
              dialogue: ["Rest your weary bones!", "Safe haven for travelers!", "Hot meals and warm beds!"]
            },
            { id: 'wayfarer-stable', name: 'Stable-Boy Tim', type: 'stable', x: 1610, y: 408, sprite: '🐎', color: '#92400e',
              dialogue: ["Your mounts need rest too!", "Fresh hay and clean water!", "Best care for your companions!"]
            },

            // Southwest Outpost
            { id: 'wild-tamer', name: 'Beast-Master Koda', type: 'stable', x: 506, y: 1205, sprite: '🦌', color: '#059669',
              dialogue: ["Wild mounts, wild adventures!", "Tame the untameable!", "Freedom rides on four legs!"]
            },
            { id: 'wild-quest', name: 'Ranger Silva', type: 'quest-giver', x: 502, y: 1208, sprite: '🏹', color: '#059669',
              dialogue: ["The wild lands need protection!", "Hunt the dangerous beasts!", "Nature's balance must be preserved!"]
            },

            // Northeast Tower
            { id: 'arcane-scholar', name: 'Archmage Mystral', type: 'trainer', x: 1404, y: 206, sprite: '🧙‍♂️', color: '#7c3aed',
              dialogue: ["Knowledge is the ultimate power!", "Learn the arcane arts!", "Magic has no limits for the dedicated!"]
            },
            { id: 'tower-vendor', name: 'Reagent-Keeper Flux', type: 'shopkeeper', x: 1408, y: 206, sprite: '⚗️', color: '#8b5cf6',
              dialogue: ["Magical components for sale!", "Quality reagents, guaranteed potency!", "Fuel your magical research!"],
              shop: [
                { id: 'mana-crystal', name: 'Mana Crystal', type: 'reagent', price: 50, description: 'Pure magical energy', icon: '💎' },
                { id: 'spell-scroll', name: 'Spell Scroll', type: 'scroll', price: 75, description: 'Contains a powerful spell', icon: '📜✨' }
              ]
            },

            // Southwest Crypt
            { id: 'crypt-keeper', name: 'Grave-Warden Morrigan', type: 'dungeon', x: 105, y: 1104, sprite: '💀', color: '#4b5563',
              dialogue: ["The dead do not rest easy...", "Brave the depths for ancient treasures!", "Only the worthy may pass!"]
            },
            { id: 'crypt-vendor', name: 'Bone-Trader Grimm', type: 'shopkeeper', x: 108, y: 1107, sprite: '☠️', color: '#1f2937',
              dialogue: ["Treasures from the departed!", "Death's bounty for the living!", "Dark wares for dark deeds!"],
              shop: [
                { id: 'bone-blade', name: 'Bone Reaper', type: 'weapon', price: 180, description: 'Sword carved from ancient bones', icon: '☠️⚔️' },
                { id: 'shadow-cloak', name: 'Cloak of Shadows', type: 'armor', price: 160, description: 'Hides you from the living', icon: '🌑👘' }
              ]
            },

            // === ADDITIONAL ROAMING NPCs ===
            // Crafting Stations (Anvils, Forges, etc.)
            { id: 'anvil-keeper1', name: 'Smith-Helper Bronson', type: 'crafting', x: 1200, y: 600, sprite: '⚒️', color: '#dc2626',
              dialogue: ["Use the anvil to craft!", "Bring materials, make wonders!", "Crafting is an art form!"]
            },
            { id: 'alchemy-station1', name: 'Brew-Master Sage', type: 'crafting', x: 800, y: 900, sprite: '⚗️', color: '#7c3aed',
              dialogue: ["Mix potions at my station!", "Combine ingredients for power!", "Alchemy transforms the mundane!"]
            },
            { id: 'cooking-station1', name: 'Chef Ramsden', type: 'crafting', x: 1500, y: 800, sprite: '🍳', color: '#f59e0b',
              dialogue: ["Cook your ingredients here!", "Hot meals give powerful buffs!", "Culinary magic is real magic!"]
            },

            // Multiple instances of same NPCs in different locations
            { id: 'mailbox-north', name: 'Northern Postal', type: 'mailbox', x: 1030, y: 160, sprite: '📬', color: '#3b82f6',
              dialogue: ["Mail service to all corners!", "Send messages anywhere!", "The post always delivers!"]
            },
            { id: 'mailbox-south', name: 'Desert Postal', type: 'mailbox', x: 1125, y: 1375, sprite: '📬', color: '#3b82f6',
              dialogue: ["Desert mail delivery!", "Even the sands can't stop us!", "Messages travel on desert winds!"]
            },
            { id: 'mailbox-west', name: 'Mountain Postal', type: 'mailbox', x: 195, y: 680, sprite: '📬', color: '#3b82f6',
              dialogue: ["Mountain mail routes!", "High-altitude delivery service!", "Your mail reaches every peak!"]
            },

            // Additional Repair NPCs
            { id: 'repair-east', name: 'Saltwater Sam', type: 'repair', x: 1745, y: 720, sprite: '🔧', color: '#6b7280',
              dialogue: ["Salt corrodes everything!", "But I can fix sea-damaged gear!", "Rust is my specialty!"]
            },

            // More Quest Givers
            { id: 'traveling-quest1', name: 'Wandering Scholar Thaddeus', type: 'quest-giver', x: 600, y: 500, sprite: '📚', color: '#6366f1',
              dialogue: ["Knowledge quests await!", "Discover ancient secrets!", "Learning leads to power!"]
            },
            { id: 'traveling-quest2', name: 'Merchant Caravan Leader', type: 'quest-giver', x: 1300, y: 1000, sprite: '🚛', color: '#92400e',
              dialogue: ["Escort our caravans!", "Trade routes need protection!", "Profitable partnerships await!"]
            },

            // More Faction Vendors
            { id: 'faction-north', name: 'Northern Alliance Rep', type: 'faction', x: 975, y: 170, sprite: '🏴', color: '#1e40af',
              dialogue: ["Serve the Northern Alliance!", "Cold steel, warm hearts!", "Loyalty to the frozen throne!"]
            },
            { id: 'faction-east', name: 'Maritime Guild Agent', type: 'faction', x: 1755, y: 725, sprite: '🏴', color: '#3b82f6',
              dialogue: ["Join the Maritime Guild!", "Rule the waves!", "The sea rewards the bold!"]
            }
        ];

        const SPAWN_POINTS = [
            { x: 1000, y: 750 },  // Center of massive world
            { x: 998, y: 750 },   // Spread around center
            { x: 1002, y: 750 },
            { x: 1000, y: 748 },
            { x: 1000, y: 752 }
        ];

        // Generate MASSIVE world map - the biggest MMORPG map ever created
        function createWorldMap() {
            const map = [];
            
            // Create massive terrain diversity
            for (let y = 0; y < WORLD_HEIGHT; y++) {
                const row = [];
                for (let x = 0; x < WORLD_WIDTH; x++) {
                    // Create diverse biomes and regions across the massive world
                    const centerX = WORLD_WIDTH / 2;
                    const centerY = WORLD_HEIGHT / 2;
                    const distanceFromCenter = Math.sqrt((x - centerX) * (x - centerX) + (y - centerY) * (y - centerY));
                    const maxDistance = Math.sqrt(centerX * centerX + centerY * centerY);
                    const normalizedDistance = distanceFromCenter / maxDistance;
                    
                    // Noise-based terrain generation for variety
                    const noise1 = Math.sin(x * 0.01) * Math.cos(y * 0.01);
                    const noise2 = Math.sin(x * 0.05) * Math.cos(y * 0.03);
                    const noise3 = Math.sin(x * 0.02) * Math.cos(y * 0.04);
                    const combinedNoise = (noise1 + noise2 * 0.5 + noise3 * 0.3) / 1.8;
                    
                    // World boundaries
                    if (y < 3 || y >= WORLD_HEIGHT - 3 || x < 3 || x >= WORLD_WIDTH - 3) {
                        row.push(TILES.water);  // Ocean boundaries
                    }
                    // Central starting town area (small compared to massive world)
                    else if (x >= centerX - 50 && x <= centerX + 50 && y >= centerY - 30 && y <= centerY + 30) {
                        if ((x >= centerX - 20 && x <= centerX - 10 && y >= centerY - 15 && y <= centerY - 5) ||
                            (x >= centerX + 10 && x <= centerX + 20 && y >= centerY - 15 && y <= centerY - 5)) {
                            // Town buildings
                            if (y === centerY - 15 || y === centerY - 5) row.push(TILES.wall);
                            else if (x === centerX - 20 || x === centerX - 10 || x === centerX + 10 || x === centerX + 20) row.push(TILES.wall);
                            else if ((x === centerX - 15 && y === centerY - 5) || (x === centerX + 15 && y === centerY - 5)) {
                                row.push(TILES.door);
                            } else row.push(TILES.floor);
                        }
                        // Town square
                        else if (x >= centerX - 5 && x <= centerX + 5 && y >= centerY - 5 && y <= centerY + 5) {
                            row.push(TILES.stone);
                        }
                        else {
                            row.push(TILES.grass);
                        }
                    }
                    // Diverse biomes based on position and noise
                    else if (normalizedDistance < 0.3) {
                        // Inner regions - grasslands and forests
                        if (combinedNoise > 0.2) row.push(TILES.stone);
                        else if (combinedNoise < -0.3) row.push(TILES.dirt);
                        else row.push(TILES.grass);
                    }
                    else if (normalizedDistance < 0.6) {
                        // Middle regions - mixed terrain
                        if (combinedNoise > 0.4) row.push(TILES.stone);
                        else if (combinedNoise > 0.1) row.push(TILES.dirt);
                        else if (combinedNoise < -0.2) row.push(TILES.water);
                        else row.push(TILES.grass);
                    }
                    else {
                        // Outer regions - wilderness and dangerous areas
                        if (combinedNoise > 0.3) row.push(TILES.stone);
                        else if (combinedNoise > -0.1) row.push(TILES.dirt);
                        else if (combinedNoise < -0.4) row.push(TILES.water);
                        else row.push(TILES.grass);
                    }
                }
                map.push(row);
            }
            return map;
        }

        const worldMap = createWorldMap();

        // Utility Functions
        function getClassStats(playerClass) {
            switch (playerClass) {
                case 'warrior': return { health: 120, mana: 30 };
                case 'mage': return { health: 80, mana: 100 };
                case 'archer': return { health: 100, mana: 50 };
                default: return { health: 100, mana: 50 };
            }
        }

        function getClassColor(playerClass) {
            switch (playerClass) {
                case 'warrior': return '#ef4444';
                case 'mage': return '#3b82f6';
                case 'archer': return '#10b981';
                default: return '#6b7280';
            }
        }

        function getClassIcon(playerClass) {
            switch (playerClass) {
                case 'warrior': return '⚔';
                case 'mage': return '✦';
                case 'archer': return '➵';
                default: return '●';
            }
        }

        function canMoveTo(x, y) {
            const tileX = Math.floor(x / TILE_SIZE);
            const tileY = Math.floor(y / TILE_SIZE);
            
            if (tileX < 0 || tileX >= WORLD_WIDTH || tileY < 0 || tileY >= WORLD_HEIGHT) {
                return false;
            }
            
            return worldMap[tileY][tileX].walkable;
        }

        function lightenColor(color, amount) {
            if (color.startsWith('#')) {
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                const newR = Math.min(255, r + amount * 255);
                const newG = Math.min(255, g + amount * 255);
                const newB = Math.min(255, b + amount * 255);
                return `rgb(${newR}, ${newG}, ${newB})`;
            }
            return color;
        }

        function darkenColor(color, amount) {
            if (color.startsWith('#')) {
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                const newR = Math.max(0, r - amount * 255);
                const newG = Math.max(0, g - amount * 255);
                const newB = Math.max(0, b - amount * 255);
                return `rgb(${newR}, ${newG}, ${newB})`;
            }
            return color;
        }

        // Game Functions
        async function initializePlayer(name, playerClass) {
            console.log('=== INITIALIZING PLAYER ===');
            console.log('Name:', name, 'Class:', playerClass);
            
            const spawnPoint = SPAWN_POINTS[Math.floor(Math.random() * SPAWN_POINTS.length)];
            console.log('Spawn point:', spawnPoint);
            
            const stats = getClassStats(playerClass);
            console.log('Class stats:', stats);
            
            const newPlayer = {
                name,
                x: spawnPoint.x * TILE_SIZE,
                y: spawnPoint.y * TILE_SIZE,
                health: stats.health,
                maxHealth: stats.health,
                mana: stats.mana,
                maxMana: stats.mana,
                level: 1,
                class: playerClass,
                color: getClassColor(playerClass),
                isMoving: false,
                direction: 'down',
                gold: 100,
                inventory: []
            };
            
            console.log('Created new player object:', newPlayer);
            console.log('Attempting Supabase connection...');

            try {
                const { data, error } = await supabase
                    .from('players')
                    .insert({
                        username: name,
                        x: newPlayer.x,
                        y: newPlayer.y,
                        health: newPlayer.health,
                        max_health: newPlayer.maxHealth,
                        mana: newPlayer.mana,
                        max_mana: newPlayer.maxMana,
                        level: newPlayer.level,
                        player_class: playerClass,
                        color: newPlayer.color,
                        direction: newPlayer.direction,
                        is_moving: false,
                        gold: newPlayer.gold,
                        zone_id: 'main-town'
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('Supabase response:', data);

                gameState.currentPlayer = {
                    id: data.id,
                    name: data.username,
                    x: data.x,
                    y: data.y,
                    health: data.health,
                    maxHealth: data.max_health,
                    mana: data.mana,
                    maxMana: data.max_mana,
                    level: data.level,
                    class: data.player_class,
                    color: data.color,
                    isMoving: data.is_moving,
                    direction: data.direction,
                    gold: data.gold,
                    inventory: []
                };

                console.log('Current player set:', gameState.currentPlayer);
                
                gameState.isConnected = true;
                console.log('Showing game UI...');
                showGameUI();
                updatePlayerStats();
                setupRealtimeSubscriptions();
                loadInitialData();
                startGameLoop();
                console.log('=== PLAYER INITIALIZATION COMPLETE ===');
            } catch (error) {
                console.error('Error creating player:', error);
                alert('Failed to create player: ' + error.message);
            }
        }

        function showGameUI() {
            console.log('=== SHOWING GAME UI ===');
            
            const characterSelect = document.getElementById('characterSelect');
            const playerStats = document.getElementById('playerStats');
            const minimapPanel = document.getElementById('minimapPanel');
            const chatPanel = document.getElementById('chatPanel');
            const controlsPanel = document.getElementById('controlsPanel');
            
            console.log('Elements found:', {
                characterSelect: !!characterSelect,
                playerStats: !!playerStats,
                minimapPanel: !!minimapPanel,
                chatPanel: !!chatPanel,
                controlsPanel: !!controlsPanel
            });
            
            if (characterSelect) characterSelect.classList.add('hidden');
            if (playerStats) playerStats.classList.remove('hidden');
            if (minimapPanel) minimapPanel.classList.remove('hidden');
            if (chatPanel) chatPanel.classList.remove('hidden');
            if (controlsPanel) controlsPanel.classList.remove('hidden');
            
            console.log('UI visibility updated');
            
            // Initialize minimap
            try {
                renderMinimap();
                console.log('Minimap rendered');
            } catch (error) {
                console.error('Error rendering minimap:', error);
            }
            
            console.log('=== GAME UI SHOWN ===');
        }

        function updatePlayerStats() {
            if (!gameState.currentPlayer) return;
            
            const player = gameState.currentPlayer;
            document.getElementById('playerNameDisplay').textContent = player.name;
            document.getElementById('playerClassDisplay').textContent = `Level ${player.level} ${player.class}`;
            document.getElementById('healthDisplay').textContent = `${player.health}/${player.maxHealth}`;
            document.getElementById('manaDisplay').textContent = `${player.mana}/${player.maxMana}`;
            document.getElementById('goldDisplay').textContent = player.gold;
            
            const healthPercent = (player.health / player.maxHealth) * 100;
            const manaPercent = (player.mana / player.maxMana) * 100;
            
            document.getElementById('healthBar').style.width = `${healthPercent}%`;
            document.getElementById('manaBar').style.width = `${manaPercent}%`;
        }

        function updatePlayersList() {
            const playerCount = document.getElementById('playerCount');
            if (playerCount) {
                playerCount.textContent = Object.keys(gameState.players).length;
            }
            
            // Update minimap when players change
            renderMinimap();
        }

        function toggleMinimap() {
            const minimapPanel = document.getElementById('minimapPanel');
            
            if (minimapPanel.classList.contains('expanded')) {
                minimapPanel.classList.remove('expanded');
            } else {
                minimapPanel.classList.add('expanded');
                renderMinimap(); // Re-render when expanded for better detail
            }
        }

        function closeControls() {
            document.getElementById('controlsPanel').classList.add('hidden');
        }

        function renderMinimap() {
            const canvas = document.getElementById('minimapCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const isExpanded = document.getElementById('minimapPanel').classList.contains('expanded');
            
            // Adjust canvas size based on expanded state
            if (isExpanded) {
                canvas.width = 400;
                canvas.height = 280;
            } else {
                canvas.width = 200;
                canvas.height = 120;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Scale factor to fit the world into the minimap
            const scaleX = canvas.width / WORLD_WIDTH;
            const scaleY = canvas.height / WORLD_HEIGHT;
            
            // Draw world background
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw buildings as small rectangles
            BUILDINGS.forEach(building => {
                const x = building.x * scaleX;
                const y = building.y * scaleY;
                const width = building.width * scaleX;
                const height = building.height * scaleY;
                
                ctx.fillStyle = '#64748b';
                ctx.fillRect(x, y, Math.max(width, 2), Math.max(height, 2));
            });
            
            // Draw players
            Object.values(gameState.players).forEach(player => {
                const x = player.x * scaleX;
                const y = player.y * scaleY;
                
                if (player.id === gameState.currentPlayer?.id) {
                    // Current player - larger and brighter
                    ctx.fillStyle = '#10b981';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                } else {
                    // Other players
                    ctx.fillStyle = '#3b82f6';
                    ctx.beginPath();
                    ctx.arc(x, y, 2, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <span class="username">${message.username}:</span> ${message.message}
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Keep only last 20 messages
            while (chatMessages.children.length > 20) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }

        async function sendMessage(message) {
            if (!gameState.currentPlayer || !message.trim()) return;

            try {
                await supabase
                    .from('chat_messages')
                    .insert({
                        player_id: gameState.currentPlayer.id,
                        username: gameState.currentPlayer.name,
                        message: message.trim(),
                        zone_id: 'main-town'
                    });
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function toggleChat() {
            const chatPanel = document.getElementById('chatPanel');
            const toggleIcon = document.getElementById('chatToggleIcon');
            
            if (chatPanel.classList.contains('expanded')) {
                chatPanel.classList.remove('expanded');
                toggleIcon.textContent = '▲';
            } else {
                chatPanel.classList.add('expanded');
                toggleIcon.textContent = '▼';
            }
        }

        function toggleMinimap() {
            const minimapPanel = document.getElementById('minimapPanel');
            
            if (minimapPanel.classList.contains('expanded')) {
                minimapPanel.classList.remove('expanded');
            } else {
                minimapPanel.classList.add('expanded');
                renderMinimap(); // Re-render when expanded for better detail
            }
        }

        function closeControls() {
            document.getElementById('controlsPanel').classList.add('hidden');
        }

        function renderMinimap() {
            const canvas = document.getElementById('minimapCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const isExpanded = document.getElementById('minimapPanel').classList.contains('expanded');
            
            // Adjust canvas size based on expanded state
            if (isExpanded) {
                canvas.width = 400;
                canvas.height = 280;
            } else {
                canvas.width = 200;
                canvas.height = 120;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Scale factor to fit the world into the minimap
            const scaleX = canvas.width / WORLD_WIDTH;
            const scaleY = canvas.height / WORLD_HEIGHT;
            
            // Draw world background
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw buildings as small rectangles
            BUILDINGS.forEach(building => {
                const x = building.x * scaleX;
                const y = building.y * scaleY;
                const width = building.width * scaleX;
                const height = building.height * scaleY;
                
                ctx.fillStyle = '#64748b';
                ctx.fillRect(x, y, Math.max(width, 2), Math.max(height, 2));
            });
            
            // Draw players
            Object.values(gameState.players).forEach(player => {
                const x = player.x * scaleX;
                const y = player.y * scaleY;
                
                if (player.id === gameState.currentPlayer?.id) {
                    // Current player - larger and brighter
                    ctx.fillStyle = '#10b981';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                } else {
                    // Other players
                    ctx.fillStyle = '#3b82f6';
                    ctx.beginPath();
                    ctx.arc(x, y, 2, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }

        async function updatePlayerPosition(player) {
            if (!player.id) return;

            try {
                await supabase
                    .from('players')
                    .update({
                        x: player.x,
                        y: player.y,
                        direction: player.direction,
                        is_moving: player.isMoving,
                        last_seen: new Date().toISOString()
                    })
                    .eq('id', player.id);
            } catch (error) {
                console.error('Error updating player position:', error);
            }
        }

        function checkInteractions(playerX, playerY) {
            const playerTileX = Math.round(playerX / TILE_SIZE);
            const playerTileY = Math.round(playerY / TILE_SIZE);
            
            for (const npc of NPCS) {
                const distance = Math.abs(npc.x - playerTileX) + Math.abs(npc.y - playerTileY);
                if (distance <= 1) {
                    return { type: 'npc', target: npc };
                }
            }
            
            return null;
        }

        function showInteractionDialog(npc) {
            gameState.interactionTarget = npc;
            
            document.getElementById('npcName').textContent = npc.name;
            document.getElementById('npcDialogue').textContent = npc.dialogue[0];
            
            const shopItems = document.getElementById('shopItems');
            shopItems.innerHTML = '';
            
            if (npc.shop && npc.shop.length > 0) {
                shopItems.classList.remove('hidden');
                npc.shop.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${item.icon} ${item.name}</strong>
                            <div style="font-size: 11px; color: hsl(120, 20%, 65%);">${item.description}</div>
                        </div>
                        <div>
                            <div style="color: hsl(60, 100%, 50%); font-weight: bold;">${item.price} Gold</div>
                            <button onclick="purchaseItem('${item.id}')" style="margin-top: 4px; padding: 4px 8px; font-size: 11px;">Buy</button>
                        </div>
                    `;
                    shopItems.appendChild(itemDiv);
                });
            } else {
                shopItems.classList.add('hidden');
            }
            
            document.getElementById('interactionOverlay').classList.remove('hidden');
            document.getElementById('interactionDialog').classList.remove('hidden');
        }

        function closeInteractionDialog() {
            document.getElementById('interactionOverlay').classList.add('hidden');
            document.getElementById('interactionDialog').classList.add('hidden');
            gameState.interactionTarget = null;
        }

        async function purchaseItem(itemId) {
            if (!gameState.interactionTarget || !gameState.currentPlayer) return;
            
            const item = gameState.interactionTarget.shop?.find(i => i.id === itemId);
            if (!item) return;
            
            if (gameState.currentPlayer.gold >= item.price) {
                // Update gold locally
                gameState.currentPlayer.gold -= item.price;
                updatePlayerStats();
                
                // Send chat message about purchase
                await sendMessage(`Purchased ${item.name} for ${item.price} gold!`);
                
                // Update player in database
                try {
                    await supabase
                        .from('players')
                        .update({ gold: gameState.currentPlayer.gold })
                        .eq('id', gameState.currentPlayer.id);
                } catch (error) {
                    console.error('Error updating gold:', error);
                }
                
                closeInteractionDialog();
            } else {
                alert('Not enough gold!');
            }
        }

        async function loadInitialData() {
            // Load players
            const { data: playersData } = await supabase
                .from('players')
                .select('*')
                .eq('zone_id', 'main-town');

            if (playersData) {
                playersData.forEach(dbPlayer => {
                    gameState.players[dbPlayer.id] = {
                        id: dbPlayer.id,
                        name: dbPlayer.username,
                        x: dbPlayer.x,
                        y: dbPlayer.y,
                        targetX: dbPlayer.x,
                        targetY: dbPlayer.y,
                        health: dbPlayer.health,
                        maxHealth: dbPlayer.max_health,
                        mana: dbPlayer.mana,
                        maxMana: dbPlayer.max_mana,
                        level: dbPlayer.level,
                        class: dbPlayer.player_class,
                        color: dbPlayer.color,
                        isMoving: dbPlayer.is_moving,
                        direction: dbPlayer.direction,
                        gold: dbPlayer.gold,
                        inventory: []
                    };
                });
                updatePlayersList();
            }

            // Load recent messages
            const { data: messagesData } = await supabase
                .from('chat_messages')
                .select('*')
                .eq('zone_id', 'main-town')
                .order('created_at', { ascending: false })
                .limit(20);

            if (messagesData) {
                messagesData.reverse().forEach(msg => {
                    addChatMessage({
                        id: msg.id,
                        username: msg.username,
                        message: msg.message,
                        created_at: msg.created_at,
                        zone_id: msg.zone_id
                    });
                });
            }
        }

        function setupRealtimeSubscriptions() {
            // Subscribe to player updates
            supabase
                .channel('players')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'players',
                        filter: 'zone_id=eq.main-town'
                    },
                    (payload) => {
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            const dbPlayer = payload.new;
                        // Smooth interpolation for other players
                        const existingPlayer = gameState.players[dbPlayer.id];
                        const newPlayer = {
                            id: dbPlayer.id,
                            name: dbPlayer.username,
                            x: dbPlayer.x,
                            y: dbPlayer.y,
                            targetX: dbPlayer.x,
                            targetY: dbPlayer.y,
                            health: dbPlayer.health,
                            maxHealth: dbPlayer.max_health,
                            mana: dbPlayer.mana,
                            maxMana: dbPlayer.max_mana,
                            level: dbPlayer.level,
                            class: dbPlayer.player_class,
                            color: dbPlayer.color,
                            isMoving: dbPlayer.is_moving,
                            direction: dbPlayer.direction,
                            gold: dbPlayer.gold,
                            inventory: []
                        };
                        
                        // Handle local vs remote player position updates differently
                        if (existingPlayer) {
                            if (dbPlayer.id === gameState.currentPlayer?.id) {
                                // For current player, keep local position for smooth movement
                                newPlayer.x = gameState.currentPlayer.x;
                                newPlayer.y = gameState.currentPlayer.y;
                                newPlayer.targetX = dbPlayer.x;
                                newPlayer.targetY = dbPlayer.y;
                            } else if (dbPlayer.x !== existingPlayer.targetX || dbPlayer.y !== existingPlayer.targetY) {
                                // For other players, smooth interpolation
                                newPlayer.x = existingPlayer.x;
                                newPlayer.y = existingPlayer.y;
                            }
                        }
                        
                        gameState.players[dbPlayer.id] = newPlayer;
                        updatePlayersList();
                        } else if (payload.eventType === 'DELETE') {
                            delete gameState.players[payload.old.id];
                            updatePlayersList();
                        }
                    }
                )
                .subscribe();

            // Subscribe to chat messages
            supabase
                .channel('chat_messages')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'chat_messages',
                        filter: 'zone_id=eq.main-town'
                    },
                    (payload) => {
                        addChatMessage({
                            id: payload.new.id,
                            username: payload.new.username,
                            message: payload.new.message,
                            created_at: payload.new.created_at,
                            zone_id: payload.new.zone_id
                        });
                    }
                )
                .subscribe();
        }

        // Game Loop
        let updateTimeout;
        let animationFrame;

        // === COMPREHENSIVE QUEST SYSTEM (300+ QUESTS) ===
        const GAME_QUESTS = {
            // STARTER QUESTS (Level 1-5)
            'first-steps': { name: 'First Steps', description: 'Talk to 3 NPCs in town', reward: 50, exp: 25, level: 1 },
            'gather-herbs': { name: 'Herb Gathering', description: 'Collect 10 healing herbs', reward: 30, exp: 20, level: 1 },
            'kill-rats': { name: 'Pest Control', description: 'Eliminate 5 rats in the cellar', reward: 40, exp: 30, level: 1 },
            'delivery-run': { name: 'Package Delivery', description: 'Deliver a package to the next town', reward: 75, exp: 35, level: 2 },
            'find-lost-cat': { name: 'Missing Pet', description: 'Find Mrs. Miggins lost cat', reward: 60, exp: 25, level: 2 },
            
            // EASY QUESTS (Level 5-10)
            'bandit-patrol': { name: 'Bandit Clearing', description: 'Clear bandits from the eastern road', reward: 150, exp: 75, level: 5 },
            'wolf-hunt': { name: 'Wolf Pack', description: 'Hunt the wolf pack terrorizing travelers', reward: 200, exp: 100, level: 6 },
            'merchant-escort': { name: 'Caravan Guard', description: 'Escort merchant caravan safely', reward: 250, exp: 125, level: 7 },
            'dungeon-explore': { name: 'Cave Exploration', description: 'Explore the mysterious cave system', reward: 300, exp: 150, level: 8 },
            'artifact-recovery': { name: 'Lost Artifact', description: 'Recover stolen magical artifact', reward: 400, exp: 200, level: 9 },
            
            // CHALLENGING QUESTS (Level 15-25)
            'dragon-threat': { name: 'Dragon Menace', description: 'Defeat the ancient dragon', reward: 2000, exp: 1000, level: 15 },
            'save-the-princess': { name: 'Royal Rescue', description: 'Rescue the kidnapped princess', reward: 1500, exp: 750, level: 12 },
            'unite-the-kingdoms': { name: 'Diplomatic Mission', description: 'Unite warring kingdoms', reward: 3000, exp: 1500, level: 20 },
            'lich-king-battle': { name: 'Undead Threat', description: 'Defeat the Lich King', reward: 2500, exp: 1250, level: 18 },
            'elemental-crisis': { name: 'Elemental Imbalance', description: 'Restore balance to the elements', reward: 1800, exp: 900, level: 16 },
            
            // PRO/ENDGAME QUESTS (Level 25+)
            'world-destroyer': { name: 'World Ender', description: 'Stop the apocalyptic threat', reward: 10000, exp: 5000, level: 30 },
            'god-slayer': { name: 'Divine Challenge', description: 'Challenge a fallen god', reward: 15000, exp: 7500, level: 35 },
            'reality-breach': { name: 'Dimensional Rift', description: 'Seal the tears in reality', reward: 8000, exp: 4000, level: 28 },
            'cosmic-balance': { name: 'Universal Order', description: 'Restore cosmic balance', reward: 12000, exp: 6000, level: 32 },
            'legend-maker': { name: 'Become Legend', description: 'Ascend to legendary status', reward: 20000, exp: 10000, level: 40 }
        };

        function startGameLoop() {
            const gameLoop = () => {
                const now = Date.now();
                const deltaTime = (now - gameState.lastUpdate) / 1000;
                gameState.lastUpdate = now;

                if (gameState.currentPlayer) {
                    let newX = gameState.currentPlayer.x;
                    let newY = gameState.currentPlayer.y;
                    let isMoving = false;
                    let direction = gameState.currentPlayer.direction;

                    const moveDistance = MOVE_SPEED * deltaTime;
                    
                    if (gameState.keys.w || gameState.keys.arrowup) {
                        const testY = Math.max(TILE_SIZE, newY - moveDistance);
                        if (canMoveTo(newX, testY)) {
                            newY = testY;
                            isMoving = true;
                            direction = 'up';
                        }
                    }
                    if (gameState.keys.s || gameState.keys.arrowdown) {
                        const testY = Math.min((WORLD_HEIGHT - 1) * TILE_SIZE, newY + moveDistance);
                        if (canMoveTo(newX, testY)) {
                            newY = testY;
                            isMoving = true;
                            direction = 'down';
                        }
                    }
                    if (gameState.keys.a || gameState.keys.arrowleft) {
                        const testX = Math.max(TILE_SIZE, newX - moveDistance);
                        if (canMoveTo(testX, newY)) {
                            newX = testX;
                            isMoving = true;
                            direction = 'left';
                        }
                    }
                    if (gameState.keys.d || gameState.keys.arrowright) {
                        const testX = Math.min((WORLD_WIDTH - 1) * TILE_SIZE, newX + moveDistance);
                        if (canMoveTo(testX, newY)) {
                            newX = testX;
                            isMoving = true;
                            direction = 'right';
                        }
                    }

                    // Update player position immediately for smooth local movement
                    const positionChanged = newX !== gameState.currentPlayer.x || newY !== gameState.currentPlayer.y;
                    const movementChanged = isMoving !== gameState.currentPlayer.isMoving;
                    
                    if (positionChanged || movementChanged) {
                        // Update local position immediately for smooth movement
                        gameState.currentPlayer.x = newX;
                        gameState.currentPlayer.y = newY;
                        gameState.currentPlayer.targetX = newX;
                        gameState.currentPlayer.targetY = newY;
                        gameState.currentPlayer.isMoving = isMoving;
                        gameState.currentPlayer.direction = direction;
                        
                        // Send position updates more frequently for smoother multiplayer
                        const timeSinceLastUpdate = now - gameState.lastPositionUpdate;
                        if (timeSinceLastUpdate >= 33) {  // 30fps updates to database for better responsiveness
                            gameState.lastPositionUpdate = now;
                            updatePlayerPosition(gameState.currentPlayer);
                        }
                    }
                }

                // Smooth interpolation for other players
                Object.values(gameState.players).forEach(player => {
                    if (player.id !== gameState.currentPlayer?.id && player.targetX !== undefined) {
                        const dx = player.targetX - player.x;
                        const dy = player.targetY - player.y;
                        
                        if (Math.abs(dx) > 0.5 || Math.abs(dy) > 0.5) {
                            player.x += dx * INTERPOLATION_SPEED * deltaTime;
                            player.y += dy * INTERPOLATION_SPEED * deltaTime;
                        } else {
                            player.x = player.targetX;
                            player.y = player.targetY;
                        }
                    }
                });

                // Render the game with optimization
                render();
                
                gameState.animationFrame += 0.08; // Reduced animation speed for better performance
                animationFrame = requestAnimationFrame(gameLoop);
            };

            animationFrame = requestAnimationFrame(gameLoop);
        }

        // Rendering
        function render() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // Skip frames for better performance if needed
            if (gameState.renderOptimizations.skipFrames > 0) {
                gameState.renderOptimizations.skipFrames--;
                return;
            }
            
            // Clear canvas with solid background for better performance
            ctx.fillStyle = 'hsl(220, 13%, 10%)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Calculate camera offset - PERFECT CENTERING
            let cameraX = 0;
            let cameraY = 0;
            
            if (gameState.currentPlayer) {
                // Center the player EXACTLY in the middle of the screen
                cameraX = canvas.width / 2 - gameState.currentPlayer.x - TILE_SIZE / 2;
                cameraY = canvas.height / 2 - gameState.currentPlayer.y - TILE_SIZE / 2;
                
                // For massive open world, allow free camera movement in all directions
                // Only clamp when near world boundaries to prevent seeing beyond the map
                const worldWidthPixels = WORLD_WIDTH * TILE_SIZE;
                const worldHeightPixels = WORLD_HEIGHT * TILE_SIZE;
                
                const minCameraX = canvas.width - worldWidthPixels;
                const minCameraY = canvas.height - worldHeightPixels;
                
                // Only clamp if we're near the edges of the massive world
                if (worldWidthPixels > canvas.width) {
                    cameraX = Math.min(0, Math.max(minCameraX, cameraX));
                }
                if (worldHeightPixels > canvas.height) {
                    cameraY = Math.min(0, Math.max(minCameraY, cameraY));
                }
            }

            ctx.save();
            ctx.translate(cameraX, cameraY);

            // Draw tiles
            drawTiles(ctx);
            
            // Draw buildings
            BUILDINGS.forEach(building => drawBuilding(ctx, building));
            
            // Draw NPCs
            NPCS.forEach(npc => drawNPC(ctx, npc));
            
            // Draw players
            Object.values(gameState.players).forEach(player => {
                const isCurrentPlayer = gameState.currentPlayer && player.id === gameState.currentPlayer.id;
                drawPlayer(ctx, player, isCurrentPlayer);
            });

            ctx.restore();
        }

        function drawTiles(ctx) {
            // OPTIMIZED RENDERING for massive world - only draw visible tiles
            const canvas = document.getElementById('gameCanvas');
            
            // Calculate current camera transform
            const transform = ctx.getTransform();
            
            // Performance optimization: reduce rendering complexity
            const viewX = -transform.e;
            const viewY = -transform.f;
            const viewWidth = canvas.width;
            const viewHeight = canvas.height;
            
            // Calculate visible tile bounds with some padding
            const startX = Math.max(0, Math.floor(viewX / TILE_SIZE) - 2);
            const endX = Math.min(WORLD_WIDTH, Math.ceil((viewX + viewWidth) / TILE_SIZE) + 2);
            const startY = Math.max(0, Math.floor(viewY / TILE_SIZE) - 2);
            const endY = Math.min(WORLD_HEIGHT, Math.ceil((viewY + viewHeight) / TILE_SIZE) + 2);
            
            // Only render visible tiles for performance in massive world
            for (let y = startY; y < endY; y++) {
                for (let x = startX; x < endX; x++) {
                    const tile = worldMap[y][x];
                    const tileX = x * TILE_SIZE;
                    const tileY = y * TILE_SIZE;

                    // Create gradient for tiles
                    const gradient = ctx.createRadialGradient(
                        tileX + TILE_SIZE/2, tileY + TILE_SIZE/2, 0,
                        tileX + TILE_SIZE/2, tileY + TILE_SIZE/2, TILE_SIZE/2
                    );

                    if (tile.type === 'water') {
                        const wave = Math.sin(gameState.animationFrame + x * 0.5 + y * 0.3) * 0.2;
                        gradient.addColorStop(0, `hsl(200, 100%, ${50 + wave * 10}%)`);
                        gradient.addColorStop(1, `hsl(200, 100%, ${40 + wave * 5}%)`);
                    } else {
                        gradient.addColorStop(0, tile.color);
                        gradient.addColorStop(1, darkenColor(tile.color, 0.2));
                    }

                    ctx.fillStyle = gradient;
                    ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);

                    // Add texture for grass
                    if (tile.type === 'grass') {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                        for (let i = 0; i < 2; i++) {
                            const px = tileX + Math.random() * TILE_SIZE;
                            const py = tileY + Math.random() * TILE_SIZE;
                            ctx.fillRect(px, py, 1, 1);
                        }
                    }

                    // Tile borders
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.lineWidth = 0.5;
                    ctx.strokeRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
                }
            }
        }

        function drawBuilding(ctx, building) {
            const x = building.x * TILE_SIZE;
            const y = building.y * TILE_SIZE;
            const w = building.width * TILE_SIZE;
            const h = building.height * TILE_SIZE;

            // Simplified shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(x + 2, y + 2, w, h);

            // Simplified building rendering
            const buildingColor = getBuildingColor(building.type);
            ctx.fillStyle = buildingColor;
            ctx.fillRect(x, y, w, h);

            // Simple border
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);

            // Icon
            ctx.fillStyle = '#ffffff';
            ctx.font = `${Math.min(w, h) * 0.25}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(building.icon, x + w / 2, y + h / 2 + 4);

            // Name
            ctx.fillStyle = '#10b981';
            ctx.font = '11px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(building.name, x + w / 2, y - 4);
        }

        function drawNPC(ctx, npc) {
            const x = npc.x * TILE_SIZE + TILE_SIZE / 2;
            const y = npc.y * TILE_SIZE + TILE_SIZE / 2;
            const size = TILE_SIZE * 0.7;
            
            const float = Math.sin(gameState.animationFrame * 2 + npc.x * 0.5) * 1; // Reduced float

            // Simplified shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.ellipse(x, y + size/2 + 3, size/2 * 0.6, size/6, 0, 0, Math.PI * 2);
            ctx.fill();

            // Simplified body
            ctx.fillStyle = npc.color;
            ctx.beginPath();
            ctx.arc(x, y + float, size/2, 0, Math.PI * 2);
            ctx.fill();

            // Simple border
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(x, y + float, size/2, 0, Math.PI * 2);
            ctx.stroke();

            // Sprite
            ctx.fillStyle = '#ffffff';
            ctx.font = `${size * 0.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(npc.sprite, x, y + float + size * 0.15);

            // Name
            ctx.fillStyle = '#10b981';
            ctx.font = '9px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(npc.name, x, y + float - size/2 - 4);

            // Simple interaction indicator
            const pulse = Math.sin(gameState.animationFrame * 3) * 0.3 + 0.7;
            ctx.fillStyle = getNPCTypeColor(npc.type);
            ctx.globalAlpha = pulse;
            ctx.beginPath();
            ctx.arc(x + size/2 - 3, y + float - size/2 + 3, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
        }

        function drawPlayer(ctx, player, isCurrentPlayer) {
            const size = TILE_SIZE * 0.85;
            const bob = player.isMoving ? Math.sin(gameState.animationFrame * 8) * 1 : 0; // Reduced bob

            // Simplified shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(player.x, player.y + size/2 + 4, size/2 * 0.6, size/6, 0, 0, Math.PI * 2);
            ctx.fill();

            // Simplified body rendering for better performance
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y + bob, size/2, 0, Math.PI * 2);
            ctx.fill();

            // Simple border
            ctx.strokeStyle = isCurrentPlayer ? '#10b981' : 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = isCurrentPlayer ? 2 : 1;
            ctx.beginPath();
            ctx.arc(player.x, player.y + bob, size/2, 0, Math.PI * 2);
            ctx.stroke();

            // Class icon
            ctx.fillStyle = '#ffffff';
            ctx.font = `${size * 0.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(getClassIcon(player.class), player.x, player.y + bob + size * 0.15);

            // Name
            ctx.fillStyle = isCurrentPlayer ? '#10b981' : '#ffffff';
            ctx.font = '10px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(player.name, player.x, player.y + bob - size/2 - 6);

            // Health bar for current player (simplified)
            if (isCurrentPlayer) {
                const barWidth = size * 0.8;
                const barHeight = 3;
                const barY = player.y + bob + size/2 + 8;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(player.x - barWidth/2, barY, barWidth, barHeight);
                
                const healthPercent = player.health / player.maxHealth;
                const healthColor = healthPercent > 0.5 ? '#10b981' : 
                                   healthPercent > 0.25 ? '#fbbf24' : '#ef4444';
                ctx.fillStyle = healthColor;
                ctx.fillRect(player.x - barWidth/2, barY, barWidth * healthPercent, barHeight);
            }
        }

        function getBuildingColor(type) {
            switch (type) {
                case 'shop': return '#dc2626';
                case 'market': return '#059669';
                case 'salon': return '#ec4899';
                case 'arena': return '#f59e0b';
                case 'tavern': return '#92400e';
                case 'guild': return '#7c3aed';
                case 'bank': return '#1f2937';
                default: return '#6b7280';
            }
        }

        function getNPCTypeColor(type) {
            switch (type) {
                case 'shopkeeper': return '#fbbf24';
                case 'vendor': return '#10b981';
                case 'trainer': return '#f59e0b';
                case 'questgiver': return '#3b82f6';
                case 'guard': return '#ef4444';
                default: return '#6b7280';
            }
        }

        // Event Listeners
        console.log('JavaScript is loading...');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== NEW MENU SYSTEM INITIALIZING ===');
            
            // === NEW MENU SYSTEM ===
            const MenuSystem = {
                selectedClass: null,
                animationState: {
                    buttonsAnimated: false,
                    titleAnimated: false
                },
                
                // Class data with enhanced stats and descriptions
                classes: {
                    warrior: {
                        name: 'Warrior',
                        icon: '⚔',
                        description: 'A mighty fighter with exceptional strength and defense',
                        stats: { hp: 150, mp: 50, strength: 18, defense: 16, agility: 12, magic: 8 },
                        abilities: ['Shield Bash', 'Berserker Rage', 'Armor Mastery'],
                        color: 'hsl(0, 70%, 50%)'
                    },
                    mage: {
                        name: 'Mage',
                        icon: '✦',
                        description: 'A master of arcane arts wielding devastating magical power',
                        stats: { hp: 80, mp: 200, strength: 8, defense: 10, agility: 14, magic: 20 },
                        abilities: ['Fireball', 'Lightning Bolt', 'Mana Shield'],
                        color: 'hsl(240, 80%, 60%)'
                    },
                    archer: {
                        name: 'Archer',
                        icon: '➵',
                        description: 'A precise marksman with unmatched agility and ranged combat',
                        stats: { hp: 110, mp: 100, strength: 14, defense: 12, agility: 18, magic: 12 },
                        abilities: ['Multi-Shot', 'Eagle Eye', 'Stealth Strike'],
                        color: 'hsl(120, 60%, 50%)'
                    }
                },
                
                // Initialize the menu system
                init() {
                    console.log('Initializing enhanced menu system...');
                    this.setupClassButtons();
                    this.setupStartButton();
                    this.setupAnimations();
                    this.selectClass('warrior'); // Default selection
                    this.animateIntro();
                },
                
                // Enhanced class selection with visual feedback
                selectClass(classType) {
                    if (!this.classes[classType]) {
                        console.error('Invalid class type:', classType);
                        return;
                    }
                    
                    console.log('=== CLASS SELECTION ===', classType);
                    this.selectedClass = classType;
                    
                    // Remove previous selections
                    document.querySelectorAll('.class-button').forEach(btn => {
                        btn.classList.remove('selected');
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = '';
                    });
                    
                    // Apply selection to new class
                    const selectedButton = document.querySelector(`.class-button[data-class="${classType}"]`);
                    if (selectedButton) {
                        selectedButton.classList.add('selected');
                        selectedButton.style.transform = 'scale(1.05)';
                        selectedButton.style.boxShadow = `0 0 25px ${this.classes[classType].color}`;
                        
                        // Add pulsing animation
                        selectedButton.style.animation = 'classPulse 2s ease-in-out infinite';
                        
                        // Update class preview
                        this.updateClassPreview(classType);
                    }
                },
                
                // Update class preview with stats and abilities
                updateClassPreview(classType) {
                    const classData = this.classes[classType];
                    
                    // Create or update preview panel
                    let preview = document.getElementById('classPreview');
                    if (!preview) {
                        preview = document.createElement('div');
                        preview.id = 'classPreview';
                        preview.style.cssText = `
                            position: absolute;
                            top: 50%;
                            right: -320px;
                            transform: translateY(-50%);
                            width: 280px;
                            background: hsl(220, 13%, 10%);
                            border: 2px solid ${classData.color};
                            border-radius: 12px;
                            padding: 20px;
                            transition: all 0.5s ease;
                            box-shadow: 0 0 30px ${classData.color}40;
                        `;
                        document.getElementById('characterSelect').appendChild(preview);
                    }
                    
                    preview.innerHTML = `
                        <h3 style="color: ${classData.color}; margin-bottom: 12px; text-align: center;">
                            ${classData.icon} ${classData.name}
                        </h3>
                        <p style="font-size: 12px; margin-bottom: 16px; color: hsl(120, 20%, 75%);">
                            ${classData.description}
                        </p>
                        <div style="margin-bottom: 16px;">
                            <h4 style="color: hsl(120, 100%, 50%); margin-bottom: 8px;">Base Stats:</h4>
                            ${Object.entries(classData.stats).map(([stat, value]) => 
                                `<div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                                    <span>${stat.toUpperCase()}:</span>
                                    <span style="color: ${classData.color};">${value}</span>
                                </div>`
                            ).join('')}
                        </div>
                        <div>
                            <h4 style="color: hsl(120, 100%, 50%); margin-bottom: 8px;">Abilities:</h4>
                            ${classData.abilities.map(ability => 
                                `<div style="font-size: 11px; margin-bottom: 4px; color: hsl(120, 20%, 75%);">
                                    • ${ability}
                                </div>`
                            ).join('')}
                        </div>
                    `;
                    
                    // Animate in
                    setTimeout(() => {
                        preview.style.right = '-300px';
                    }, 100);
                },
                
                // Enhanced class button setup
                setupClassButtons() {
                    const classButtons = document.querySelectorAll('.class-button');
                    console.log('Setting up enhanced class buttons:', classButtons.length);
                    
                    classButtons.forEach((button) => {
                        const classType = button.dataset.class;
                        const classData = this.classes[classType];
                        
                        if (!classData) return;
                        
                        // Enhanced hover effects
                        button.addEventListener('mouseenter', () => {
                            if (!button.classList.contains('selected')) {
                                button.style.transform = 'scale(1.02)';
                                button.style.boxShadow = `0 0 15px ${classData.color}60`;
                            }
                        });
                        
                        button.addEventListener('mouseleave', () => {
                            if (!button.classList.contains('selected')) {
                                button.style.transform = 'scale(1)';
                                button.style.boxShadow = '';
                            }
                        });
                        
                        // Click handler with enhanced feedback
                        button.addEventListener('click', () => {
                            // Click animation
                            button.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                this.selectClass(classType);
                            }, 100);
                            
                            // Play selection sound effect (visual feedback)
                            this.playSelectionEffect(button);
                        });
                    });
                },
                
                // Visual selection effect
                playSelectionEffect(button) {
                    const effect = document.createElement('div');
                    effect.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 4px;
                        height: 4px;
                        background: hsl(120, 100%, 50%);
                        border-radius: 50%;
                        animation: selectionRipple 0.6s ease-out;
                        pointer-events: none;
                        z-index: 10;
                    `;
                    
                    button.style.position = 'relative';
                    button.appendChild(effect);
                    
                    setTimeout(() => effect.remove(), 600);
                },
                
                // Enhanced start button setup
                setupStartButton() {
                    const startButton = document.getElementById('startGame');
                    if (!startButton) {
                        console.error('Start button not found!');
                        return;
                    }
                    
                    console.log('Setting up enhanced start button...');
                    
                    // Enhanced styling
                    startButton.style.cssText += `
                        font-size: 16px;
                        font-weight: bold;
                        text-transform: uppercase;
                        letter-spacing: 2px;
                        position: relative;
                        overflow: hidden;
                        transition: all 0.3s ease;
                    `;
                    
                    // Hover effects
                    startButton.addEventListener('mouseenter', () => {
                        startButton.style.transform = 'translateY(-2px)';
                        startButton.style.boxShadow = '0 10px 25px hsl(120, 100%, 50%, 0.4)';
                    });
                    
                    startButton.addEventListener('mouseleave', () => {
                        startButton.style.transform = 'translateY(0)';
                        startButton.style.boxShadow = '0 0 10px hsl(120, 100%, 50%, 0.3)';
                    });
                    
                    // Enhanced click handler
                    startButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleStartGame();
                    });
                },
                
                // Enhanced start game handler with validation
                handleStartGame() {
                    console.log('=== ENHANCED START ADVENTURE ===');
                    
                    const nameInput = document.getElementById('playerName');
                    const playerName = nameInput ? nameInput.value.trim() : '';
                    
                    // Enhanced validation
                    const validation = this.validateGameStart(playerName);
                    if (!validation.valid) {
                        this.showValidationError(validation.message);
                        return;
                    }
                    
                    // Success animation
                    this.playStartAnimation(() => {
                        console.log('Initializing player:', { name: playerName, class: this.selectedClass });
                        initializePlayer(playerName, this.selectedClass);
                    });
                },
                
                // Enhanced validation
                validateGameStart(playerName) {
                    if (!playerName || playerName.length < 2) {
                        return { valid: false, message: 'Please enter a name with at least 2 characters!' };
                    }
                    
                    if (playerName.length > 20) {
                        return { valid: false, message: 'Name must be 20 characters or less!' };
                    }
                    
                    if (!/^[a-zA-Z0-9_\s]+$/.test(playerName)) {
                        return { valid: false, message: 'Name can only contain letters, numbers, spaces, and underscores!' };
                    }
                    
                    if (!this.selectedClass) {
                        return { valid: false, message: 'Please select a class!' };
                    }
                    
                    return { valid: true };
                },
                
                // Enhanced error display
                showValidationError(message) {
                    const nameInput = document.getElementById('playerName');
                    
                    // Create error message
                    let errorDiv = document.getElementById('validationError');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.id = 'validationError';
                        errorDiv.style.cssText = `
                            color: hsl(0, 100%, 70%);
                            font-size: 12px;
                            margin-top: 8px;
                            text-align: center;
                            opacity: 0;
                            transition: opacity 0.3s ease;
                        `;
                        nameInput.parentNode.insertBefore(errorDiv, nameInput.nextSibling);
                    }
                    
                    errorDiv.textContent = message;
                    errorDiv.style.opacity = '1';
                    
                    // Shake animation for input
                    nameInput.style.animation = 'inputShake 0.5s ease';
                    nameInput.style.borderColor = 'hsl(0, 100%, 60%)';
                    
                    // Clear error after 3 seconds
                    setTimeout(() => {
                        errorDiv.style.opacity = '0';
                        nameInput.style.animation = '';
                        nameInput.style.borderColor = '';
                    }, 3000);
                },
                
                // Start game animation
                playStartAnimation(callback) {
                    const startButton = document.getElementById('startGame');
                    const characterSelect = document.getElementById('characterSelect');
                    
                    // Button animation
                    startButton.textContent = 'STARTING...';
                    startButton.style.background = 'hsl(120, 100%, 30%)';
                    startButton.disabled = true;
                    
                    // Fade out animation
                    characterSelect.style.transition = 'all 1s ease';
                    characterSelect.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    characterSelect.style.opacity = '0';
                    
                    setTimeout(callback, 1000);
                },
                
                // Menu entrance animations
                animateIntro() {
                    const title = document.querySelector('#characterSelect h1');
                    const subtitle = document.querySelector('#characterSelect p');
                    const nameInput = document.getElementById('playerName');
                    const classButtons = document.querySelectorAll('.class-button');
                    const startButton = document.getElementById('startGame');
                    
                    // Animate title
                    if (title) {
                        title.style.opacity = '0';
                        title.style.transform = 'translateY(-20px)';
                        setTimeout(() => {
                            title.style.transition = 'all 0.8s ease';
                            title.style.opacity = '1';
                            title.style.transform = 'translateY(0)';
                        }, 200);
                    }
                    
                    // Animate subtitle and input
                    [subtitle, nameInput].forEach((el, i) => {
                        if (el) {
                            el.style.opacity = '0';
                            el.style.transform = 'translateY(20px)';
                            setTimeout(() => {
                                el.style.transition = 'all 0.6s ease';
                                el.style.opacity = '1';
                                el.style.transform = 'translateY(0)';
                            }, 400 + i * 200);
                        }
                    });
                    
                    // Animate class buttons
                    classButtons.forEach((btn, i) => {
                        btn.style.opacity = '0';
                        btn.style.transform = 'translateY(30px) scale(0.8)';
                        setTimeout(() => {
                            btn.style.transition = 'all 0.6s ease';
                            btn.style.opacity = '1';
                            btn.style.transform = 'translateY(0) scale(1)';
                        }, 800 + i * 150);
                    });
                    
                    // Animate start button
                    if (startButton) {
                        startButton.style.opacity = '0';
                        startButton.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            startButton.style.transition = 'all 0.8s ease';
                            startButton.style.opacity = '1';
                            startButton.style.transform = 'translateY(0)';
                        }, 1200);
                    }
                },
                
                // Setup animations and effects
                setupAnimations() {
                    // Add CSS animations
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes classPulse {
                            0%, 100% { box-shadow: 0 0 25px ${this.selectedClass ? this.classes[this.selectedClass].color : 'hsl(120, 100%, 50%)'}; }
                            50% { box-shadow: 0 0 35px ${this.selectedClass ? this.classes[this.selectedClass].color : 'hsl(120, 100%, 50%)'}; }
                        }
                        @keyframes selectionRipple {
                            0% { width: 4px; height: 4px; opacity: 1; }
                            100% { width: 100px; height: 100px; opacity: 0; }
                        }
                        @keyframes inputShake {
                            0%, 100% { transform: translateX(0); }
                            25% { transform: translateX(-5px); }
                            75% { transform: translateX(5px); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            };
            
            // Initialize the new menu system
            MenuSystem.init();

            // Keyboard controls
            document.addEventListener('keydown', function(e) {
                const key = e.key.toLowerCase();
                if (['w', 'a', 's', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(key)) {
                    e.preventDefault();
                    gameState.keys[key] = true;
                } else if (key === 'e' || key === ' ') {
                    if (document.activeElement?.tagName !== 'INPUT') {
                        e.preventDefault();
                        handleInteraction();
                    }
                } else if (key === 'enter') {
                    if (document.activeElement === document.getElementById('chatInput')) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                }
            });

            document.addEventListener('keyup', function(e) {
                const key = e.key.toLowerCase();
                gameState.keys[key] = false;
            });

            // Chat functionality
            document.getElementById('sendButton').addEventListener('click', handleSendMessage);
            
            function handleSendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                if (message) {
                    sendMessage(message);
                    chatInput.value = '';
                }
            }

            function handleInteraction() {
                if (!gameState.currentPlayer) return;
                
                const interaction = checkInteractions(gameState.currentPlayer.x, gameState.currentPlayer.y);
                if (interaction?.type === 'npc') {
                    showInteractionDialog(interaction.target);
                }
            }

            // Interaction dialog
            document.getElementById('closeDialog').addEventListener('click', closeInteractionDialog);
            document.getElementById('interactionOverlay').addEventListener('click', closeInteractionDialog);

            // Global purchase function
            window.purchaseItem = purchaseItem;

            // Cleanup on page unload
            window.addEventListener('beforeunload', async function() {
                if (gameState.currentPlayer?.id) {
                    try {
                        await supabase
                            .from('players')
                            .delete()
                            .eq('id', gameState.currentPlayer.id);
                    } catch (error) {
                        console.error('Error cleaning up player:', error);
                    }
                }
            });
        });
    </script>
</body>
</html>
